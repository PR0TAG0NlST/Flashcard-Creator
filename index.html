<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Synapse</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        'inter': ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* Base styles */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* For the card flip animation */
        .scene {
            perspective: 1000px;
        }

        .card {
            transform-style: preserve-3d;
            transition: transform 0.6s;
        }

        .card.is-flipped {
            transform: rotateY(180deg);
        }

        .card-face {
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
        }

        .card-face-back {
            transform: rotateY(180deg);
        }
         .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="h-full bg-gray-50 dark:bg-slate-900 overflow-hidden">

    <!-- App Root -->
    <div id="app-root" class="h-full">
        <!-- This div will be populated by JavaScript -->
    </div>

    <!-- Firebase and App Logic -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, getDoc, setDoc, onSnapshot, deleteDoc, query, where, updateDoc, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- IMPORTANT: PASTE YOUR FIREBASE CONFIGURATION HERE ---
        const firebaseConfig = {
	  apiKey: "AIzaSyDv0HUX80zaG27ECTBpQNQQGzQA88cqrGw",
  	  authDomain: "flashcard-generator-by-protag.firebaseapp.com",
  	  projectId: "flashcard-generator-by-protag",
  	  storageBucket: "flashcard-generator-by-protag.firebasestorage.app",
 	  messagingSenderId: "396232133147",
  	  appId: "1:396232133147:web:3139d331b0ad2b38df86be",
  	  measurementId: "G-DG0MQYCWZC"
        };
        // --- END OF FIREBASE CONFIGURATION ---
        const geminiApiKey = "AIzaSyCgUaG0LID_C9XbRF1yd1Apo9YiI581LAs";
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Global variables
        let app, db, auth, userId, userProfile;
        let allUserDecks = [];
        let progressSubjects = [];
        let progressChartInstance = null;
        let allPublicDecks = [];
        let chatHistory = [];


        // --- FUNCTION DECLARATIONS (ORDERED TO PREVENT REFERENCE ERRORS) ---

        // --- MODAL & UI HELPERS ---

        function renderModal(id, title, content, onSave, saveLabel = 'Save') {
             const modalHTML = `
                <div id="${id}" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md mx-4">
                        <div class="flex items-center justify-between p-4 border-b dark:border-gray-700">
                            <h3 class="text-lg font-medium">${title}</h3>
                            <button class="modal-close-btn text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </button>
                        </div>
                        <div class="p-6">${content}</div>
                        <div class="flex justify-end p-4 bg-gray-50 dark:bg-gray-800 border-t dark:border-gray-700 rounded-b-lg">
                            <button class="modal-close-btn px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 mr-2">Cancel</button>
                            <button id="modal-save-btn" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700">${saveLabel}</button>
                        </div>
                    </div>
                </div>`;
            document.getElementById('modals-container').innerHTML = modalHTML;
            
            const modal = document.getElementById(id);
            modal.querySelector('#modal-save-btn').addEventListener('click', onSave);
            modal.querySelectorAll('.modal-close-btn').forEach(btn => btn.addEventListener('click', () => modal.remove()));
        }

        function renderEditProfileModal() {
            const currentUsername = userProfile?.username || '';
            renderModal('edit-profile-modal', 'Edit Profile', `
                <form id="edit-profile-form">
                    <label for="username-edit" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Username</label>
                    <input type="text" id="username-edit" required class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm" value="${currentUsername}">
                </form>
            `, () => {
                const newUsername = document.getElementById('username-edit').value.trim();
                if (newUsername) {
                    updateUserProfile(newUsername);
                    document.getElementById('edit-profile-modal')?.remove();
                }
            }, 'Save Changes');
        }

        function renderShareProfileModal() {
            const profileUrl = `${window.location.origin}${window.location.pathname}?profile=${userId}`;
            const modalContent = `
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Share this link with others to let them view your public profile and decks.</p>
                <div class="flex items-center space-x-2">
                    <input type="text" id="profile-share-link" readonly class="flex-1 px-3 py-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm sm:text-sm" value="${profileUrl}">
                    <button id="copy-share-link-btn" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700">Copy</button>
                </div>
                <p id="copy-success-msg" class="text-sm text-green-500 mt-2 hidden">Copied to clipboard!</p>
            `;
            renderModal('share-profile-modal', 'Share Your Profile', modalContent, () => {}, '');
            const shareModal = document.getElementById('share-profile-modal');
            shareModal.querySelector('#modal-save-btn').style.display = 'none';
            shareModal.querySelector('.modal-close-btn:not(h3 ~ .modal-close-btn)').style.display = 'none';

            shareModal.querySelector('#copy-share-link-btn').addEventListener('click', () => {
                const linkInput = document.getElementById('profile-share-link');
                linkInput.select();
                linkInput.setSelectionRange(0, 99999); // For mobile devices
                try {
                    document.execCommand('copy');
                    const successMsg = document.getElementById('copy-success-msg');
                    successMsg.classList.remove('hidden');
                    setTimeout(() => successMsg.classList.add('hidden'), 2000);
                } catch (err) {
                    console.error('Failed to copy text: ', err);
                }
            });
        }
        
        function renderPlaceholderModal(featureName) {
            const modalContent = `
                <div class="text-center">
                    <p class="text-gray-600 dark:text-gray-400">The ability to ${featureName} is coming soon. Stay tuned!</p>
                </div>
            `;
            renderModal('placeholder-modal', featureName, modalContent, () => {}, '');
            const modal = document.getElementById('placeholder-modal');
            modal.querySelector('#modal-save-btn').style.display = 'none';
            modal.querySelector('.modal-close-btn:not(h3 ~ .modal-close-btn)').style.display = 'none';
        }

        function renderAddDeckModal() {
            renderModal('add-deck-modal', 'Create New Deck', `
                <form id="create-deck-form">
                    <label for="deck-topic" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Topic</label>
                    <input type="text" id="deck-topic" required class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </form>`, 
            () => {
                const topic = document.getElementById('deck-topic').value;
                if (topic) {
                    createDeck(topic);
                    document.getElementById('add-deck-modal')?.remove();
                }
            }, 'Create Deck');
        }

        function renderAddSubjectModal() {
            renderModal('add-subject-modal', 'Add New Subject', `
                <form id="add-subject-form">
                    <label for="subject-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Subject Name</label>
                    <input type="text" id="subject-name" required class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </form>`, 
            () => {
                const name = document.getElementById('subject-name').value.trim();
                if (name) {
                    addProgressSubject(name);
                    document.getElementById('add-subject-modal')?.remove();
                }
            }, 'Add Subject');
        }

        function renderAddUnitModal(subjectId, currentUnitCount) {
             const modalContent = `
                <div>
                    <!-- Tabs -->
                    <div class="border-b border-gray-200 dark:border-gray-700">
                        <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                            <button id="simple-add-tab-unit" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-blue-600 border-blue-600">
                                Simple Add
                            </button>
                            <button id="bulk-add-tab-unit" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300 dark:hover:border-gray-600 border-transparent">
                                Bulk Add
                            </button>
                        </nav>
                    </div>
                    <form class="mt-6">
                        <div id="simple-add-view-unit">
                            <label for="unit-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Unit Name</label>
                            <input type="text" id="unit-name" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm">
                        </div>
                        <div id="bulk-add-view-unit" class="hidden">
                             <label for="bulk-units-count" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Number of Units to Add</label>
                             <input type="number" id="bulk-units-count" value="4" min="1" max="20" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm">
                             <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">This will create units with default names (e.g., Unit ${currentUnitCount + 1}, Unit ${currentUnitCount + 2}, ...).</p>
                        </div>
                    </form>
                </div>
            `;

            renderModal('add-unit-modal', 'Add New Unit(s)', modalContent, () => {
                const isBulk = !document.getElementById('bulk-add-view-unit').classList.contains('hidden');
                let newUnits = [];

                if (isBulk) {
                    const count = parseInt(document.getElementById('bulk-units-count').value, 10);
                    if (count > 0) {
                        for (let i = 1; i <= count; i++) {
                            newUnits.push({ name: `Unit ${currentUnitCount + i}`, topics: [] });
                        }
                    }
                } else {
                    const unitName = document.getElementById('unit-name').value.trim();
                    if (unitName) {
                        newUnits.push({ name: unitName, topics: [] });
                    }
                }

                if (newUnits.length > 0) {
                    addMultipleUnitsToSubject(subjectId, newUnits);
                    document.getElementById('add-unit-modal')?.remove();
                }

            }, 'Add Unit(s)');

            // Tab switching logic
            const simpleTab = document.getElementById('simple-add-tab-unit');
            const bulkTab = document.getElementById('bulk-add-tab-unit');
            const simpleView = document.getElementById('simple-add-view-unit');
            const bulkView = document.getElementById('bulk-add-view-unit');

            const activateTab = (tabToActivate, viewToShow) => {
                simpleTab.classList.remove('text-blue-600', 'border-blue-600');
                simpleTab.classList.add('text-gray-500', 'border-transparent');
                bulkTab.classList.remove('text-blue-600', 'border-blue-600');
                bulkTab.classList.add('text-gray-500', 'border-transparent');

                tabToActivate.classList.add('text-blue-600', 'border-blue-600');
                tabToActivate.classList.remove('text-gray-500', 'border-transparent');

                simpleView.classList.add('hidden');
                bulkView.classList.add('hidden');
                viewToShow.classList.remove('hidden');
            };

            simpleTab.addEventListener('click', () => activateTab(simpleTab, simpleView));
            bulkTab.addEventListener('click', () => activateTab(bulkTab, bulkView));
        }
        
        function renderRenameUnitModal(subjectId, unitIndex, currentName) {
            renderModal('rename-unit-modal', 'Rename Unit', `
                <form>
                    <label for="unit-name-rename" class="block text-sm font-medium text-gray-700 dark:text-gray-300">New Unit Name</label>
                    <input type="text" id="unit-name-rename" required class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm" value="${currentName}">
                </form>`, 
            () => {
                const newName = document.getElementById('unit-name-rename').value.trim();
                if (newName && newName !== currentName) {
                    updateUnitName(subjectId, unitIndex, newName);
                    document.getElementById('rename-unit-modal')?.remove();
                }
            }, 'Rename');
        }

        function renderRenameSubjectModal(subjectId, currentName) {
            renderModal('rename-subject-modal', 'Rename Subject', `
                <form>
                    <label for="subject-name-rename" class="block text-sm font-medium text-gray-700 dark:text-gray-300">New Subject Name</label>
                    <input type="text" id="subject-name-rename" required class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm" value="${currentName}">
                </form>`, 
            () => {
                const newName = document.getElementById('subject-name-rename').value.trim();
                if (newName && newName !== currentName) {
                    updateSubjectName(subjectId, newName);
                    document.getElementById('rename-subject-modal')?.remove();
                }
            }, 'Rename');
        }

        function renderEditTopicModal(subjectId, unitIndex, topicIndex, topic) {
            renderModal('edit-topic-modal', 'Edit Topic', `
                <form>
                    <label for="topic-name-edit" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Topic Name</label>
                    <input type="text" id="topic-name-edit" required class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm" value="${topic.name}">
                </form>`, 
            () => {
                const newName = document.getElementById('topic-name-edit').value.trim();
                if (newName && newName !== topic.name) {
                    updateTopicName(subjectId, unitIndex, topicIndex, newName);
                    document.getElementById('edit-topic-modal')?.remove();
                }
            }, 'Save');
        }
        
        function renderRenameDeckModal(deckId, currentTopic) {
            renderModal('rename-deck-modal', 'Rename Deck', `
                <form id="rename-deck-form">
                    <label for="deck-topic-rename" class="block text-sm font-medium text-gray-700 dark:text-gray-300">New Topic Name</label>
                    <input type="text" id="deck-topic-rename" required class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" value="${currentTopic}">
                </form>`,
            () => {
                const newTopic = document.getElementById('deck-topic-rename').value.trim();
                if (newTopic && newTopic !== currentTopic) {
                    updateDeckTopic(deckId, newTopic);
                    document.getElementById('rename-deck-modal')?.remove();
                } else {
                    document.getElementById('rename-deck-modal')?.remove();
                }
            }, 'Rename Deck');
        }

        function renderEditCardModal(deckId, cardIndex, card) {
            const modalContent = `
                <form id="edit-card-form" class="space-y-4">
                    <div>
                        <label for="edit-card-question" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Question</label>
                        <textarea id="edit-card-question" rows="3" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">${card.question}</textarea>
                    </div>
                    <div>
                        <label for="edit-card-answer" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Answer</label>
                        <textarea id="edit-card-answer" rows="3" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">${card.answer}</textarea>
                    </div>
                </form>
            `;

            renderModal('edit-card-modal', 'Edit Card', modalContent,
            () => { // onSave logic
                const newQuestion = document.getElementById('edit-card-question').value.trim();
                const newAnswer = document.getElementById('edit-card-answer').value.trim();

                if (newQuestion && newAnswer) {
                    updateCard(deckId, cardIndex, newQuestion, newAnswer);
                    document.getElementById('edit-card-modal')?.remove();
                }
            }, 'Save Changes');
        }

        function renderAddTopicModal(subjectId, unitIndex) {
             const modalContent = `
                <div>
                    <!-- Tabs -->
                    <div class="border-b border-gray-200 dark:border-gray-700">
                        <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                            <button id="simple-add-tab-topic" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-blue-600 border-blue-600">
                                Simple Add
                            </button>
                            <button id="bulk-add-tab-topic" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300 dark:hover:border-gray-600 border-transparent">
                                Bulk Add
                            </button>
                        </nav>
                    </div>
                    <form class="mt-6">
                        <div id="simple-add-view-topic">
                            <label for="topic-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Topic Name</label>
                            <input type="text" id="topic-name" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm">
                        </div>
                        <div id="bulk-add-view-topic" class="hidden">
                             <label for="bulk-topics-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Topics</label>
                             <textarea id="bulk-topics-input" rows="10" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm" placeholder="Topic 1, Topic 2, Topic 3"></textarea>
                             <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">Separate topics with a comma (,).</p>
                        </div>
                    </form>
                </div>
            `;
            renderModal('add-topic-modal', 'Add New Topic(s)', modalContent, () => {
                const isBulk = !document.getElementById('bulk-add-view-topic').classList.contains('hidden');
                let newTopics = [];
                if(isBulk) {
                    const bulkText = document.getElementById('bulk-topics-input').value.trim();
                    if(bulkText) {
                        newTopics = bulkText.split(',').map(name => name.trim()).filter(name => name);
                    }
                } else {
                    const topicName = document.getElementById('topic-name').value.trim();
                    if(topicName) newTopics.push(topicName);
                }
                
                if (newTopics.length > 0) {
                    addMultipleTopicsToUnit(subjectId, unitIndex, newTopics);
                    document.getElementById('add-topic-modal')?.remove();
                }

            }, 'Add Topic(s)');

            // Tab switching logic
            const simpleTab = document.getElementById('simple-add-tab-topic');
            const bulkTab = document.getElementById('bulk-add-tab-topic');
            const simpleView = document.getElementById('simple-add-view-topic');
            const bulkView = document.getElementById('bulk-add-view-topic');
            
            const activateTab = (tabToActivate, viewToShow) => {
                simpleTab.classList.remove('text-blue-600', 'border-blue-600');
                simpleTab.classList.add('text-gray-500', 'border-transparent');
                bulkTab.classList.remove('text-blue-600', 'border-blue-600');
                bulkTab.classList.add('text-gray-500', 'border-transparent');
                
                tabToActivate.classList.add('text-blue-600', 'border-blue-600');
                tabToActivate.classList.remove('text-gray-500', 'border-transparent');

                simpleView.classList.add('hidden');
                bulkView.classList.add('hidden');
                viewToShow.classList.remove('hidden');
            };

            simpleTab.addEventListener('click', () => activateTab(simpleTab, simpleView));
            bulkTab.addEventListener('click', () => activateTab(bulkTab, bulkView));
        }

        function renderAddCardModal(deckId) {
            const modalContent = `
                <div>
                    <!-- Tabs -->
                    <div class="border-b border-gray-200 dark:border-gray-700">
                        <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                            <button id="simple-add-tab" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-blue-600 border-blue-600">
                                Simple Add
                            </button>
                            <button id="bulk-add-tab" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300 dark:hover:border-gray-600 border-transparent">
                                Bulk Add
                            </button>
                             <button id="ai-add-tab" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300 dark:hover:border-gray-600 border-transparent">
                                Generate with AI
                            </button>
                        </nav>
                    </div>

                    <!-- Form Content -->
                    <form id="add-card-form" class="mt-6">
                        <!-- Simple Add View (Default) -->
                        <div id="simple-add-view" class="space-y-4">
                            <div>
                                <label for="card-question" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Question</label>
                                <textarea id="card-question" rows="3" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></textarea>
                            </div>
                            <div>
                                <label for="card-answer" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Answer</label>
                                <textarea id="card-answer" rows="3" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></textarea>
                            </div>
                        </div>

                        <!-- Bulk Add View (Hidden by default) -->
                        <div id="bulk-add-view" class="hidden">
                             <div>
                                <label for="bulk-cards-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Cards</label>
                                <textarea id="bulk-cards-input" rows="10" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Question 1: Answer 1\n\nQuestion 2: Answer 2"></textarea>
                                <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">Separate cards with a blank line. Separate question and answer with a colon (:).</p>
                            </div>
                        </div>
                        <!-- AI Add View (Hidden by default) -->
                        <div id="ai-add-view" class="hidden">
                             <div class="space-y-4">
                                <div>
                                    <label for="ai-topic-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Topic or Notes</label>
                                    <textarea id="ai-topic-input" rows="8" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Enter a topic like 'Cellular Respiration' or paste your notes here..."></textarea>
                                    <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">The AI will generate flashcards based on your input.</p>
                                </div>
                                <div>
                                    <label for="ai-card-count" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Number of Cards: <span id="ai-card-count-label" class="font-bold">8</span></label>
                                    <input type="range" id="ai-card-count" name="ai-card-count" min="3" max="20" value="8" class="mt-1 block w-full">
                                </div>
                                <div id="ai-loader" class="hidden mt-4 flex items-center justify-center">
                                    <div class="loader"></div>
                                    <p class="ml-2 text-sm text-gray-500">Generating cards...</p>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            `;

            renderModal('add-card-modal', 'Add New Card(s)', modalContent,
            () => { // onSave logic for Simple and Bulk add
                const simpleAddView = document.getElementById('simple-add-view');
                let newCards = [];

                if (!simpleAddView.classList.contains('hidden')) { // Simple Add Mode
                    const question = document.getElementById('card-question').value.trim();
                    const answer = document.getElementById('card-answer').value.trim();
                    if (question && answer) {
                        newCards.push({ question, answer });
                    }
                } else { // Bulk Add Mode
                    const bulkText = document.getElementById('bulk-cards-input').value.trim();
                    if (bulkText) {
                        const cardBlocks = bulkText.split('\n\n');
                        newCards = cardBlocks
                            .map(block => {
                                if (block.trim() === '') return null;
                                const parts = block.split(':');
                                if (parts.length >= 2) {
                                    const question = parts[0].trim();
                                    const answer = parts.slice(1).join(':').trim();
                                    if (question && answer) {
                                        return { question, answer };
                                    }
                                }
                                return null;
                            })
                            .filter(card => card !== null);
                    }
                }

                if (newCards.length > 0) {
                    addMultipleCardsToDeck(deckId, newCards);
                    document.getElementById('add-card-modal')?.remove();
                }

            }, 'Add Card(s)');

            // --- Tab Switching Logic ---
            const simpleTab = document.getElementById('simple-add-tab');
            const bulkTab = document.getElementById('bulk-add-tab');
            const aiTab = document.getElementById('ai-add-tab');
            const simpleView = document.getElementById('simple-add-view');
            const bulkView = document.getElementById('bulk-add-view');
            const aiView = document.getElementById('ai-add-view');
            const saveButton = document.getElementById('modal-save-btn');
            
            const allTabs = [simpleTab, bulkTab, aiTab];
            const allViews = [simpleView, bulkView, aiView];
            
            function activateTab(activeTab, activeView) {
                allTabs.forEach(tab => {
                    tab.classList.remove('text-blue-600', 'border-blue-600');
                    tab.classList.add('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300', 'dark:text-gray-400', 'dark:hover:text-gray-300', 'dark:hover:border-gray-600', 'border-transparent');
                });
                allViews.forEach(view => view.classList.add('hidden'));

                activeTab.classList.add('text-blue-600', 'border-blue-600');
                activeTab.classList.remove('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300', 'dark:text-gray-400', 'dark:hover:text-gray-300', 'dark:hover:border-gray-600', 'border-transparent');
                activeView.classList.remove('hidden');

                if (activeTab === aiTab) {
                    saveButton.textContent = 'Generate Cards';
                    saveButton.onclick = () => generateCardsWithAI(deckId);
                } else {
                    saveButton.textContent = 'Add Card(s)';
                    saveButton.onclick = () => {
                         const simpleAddView = document.getElementById('simple-add-view');
                        let newCards = [];

                        if (document.getElementById('simple-add-view') && !document.getElementById('simple-add-view').classList.contains('hidden')) {
                            const question = document.getElementById('card-question').value.trim();
                            const answer = document.getElementById('card-answer').value.trim();
                            if (question && answer) {
                                newCards.push({ question, answer });
                            }
                        } else if (document.getElementById('bulk-add-view') && !document.getElementById('bulk-add-view').classList.contains('hidden')) {
                            const bulkText = document.getElementById('bulk-cards-input').value.trim();
                            if (bulkText) {
                                const cardBlocks = bulkText.split('\n\n');
                                newCards = cardBlocks
                                    .map(block => {
                                        if (block.trim() === '') return null;
                                        const parts = block.split(':');
                                        if (parts.length >= 2) {
                                            const question = parts[0].trim();
                                            const answer = parts.slice(1).join(':').trim();
                                            if (question && answer) {
                                                return { question, answer };
                                            }
                                        }
                                        return null;
                                    })
                                    .filter(card => card !== null);
                            }
                        }

                        if (newCards.length > 0) {
                            addMultipleCardsToDeck(deckId, newCards);
                            document.getElementById('add-card-modal')?.remove();
                        }
                    };
                }
            }
            
            simpleTab.addEventListener('click', () => activateTab(simpleTab, simpleView));
            bulkTab.addEventListener('click', () => activateTab(bulkTab, bulkView));
            aiTab.addEventListener('click', () => activateTab(aiTab, aiView));
            
            const cardCountSlider = document.getElementById('ai-card-count');
            const cardCountLabel = document.getElementById('ai-card-count-label');
            if(cardCountSlider && cardCountLabel) {
                cardCountSlider.addEventListener('input', (e) => {
                    cardCountLabel.textContent = e.target.value;
                });
            }
        }

        function renderPublishDeckModal(deckId) {
            const modalContent = `
                <form id="publish-deck-form">
                    <label for="deck-summary" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Deck Summary (Optional)</label>
                    <textarea id="deck-summary" rows="4" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Briefly describe what this deck is about..."></textarea>
                    <p class="mt-2 text-xs text-gray-500">If left blank, an AI-generated summary will be created.</p>
                     <div id="ai-summary-loader" class="hidden mt-4 flex items-center justify-center">
                        <div class="loader"></div>
                        <p class="ml-2 text-sm text-gray-500">Generating AI summary...</p>
                    </div>
                </form>
            `;
            renderModal('publish-deck-modal', 'Publish Deck', modalContent, async () => {
                let summary = document.getElementById('deck-summary').value.trim();
                const loader = document.getElementById('ai-summary-loader');
                
                if (!summary) {
                    loader.classList.remove('hidden');
                    const deck = allUserDecks.find(d => d.id === deckId);
                    if (deck && deck.cards.length > 0) {
                        summary = await generateSummaryWithAI(deck.cards);
                    } else {
                        summary = "A collection of flashcards.";
                    }
                    loader.classList.add('hidden');
                }
                
                makeDeckPublic(deckId, summary);
                document.getElementById('publish-deck-modal')?.remove();
            }, 'Publish');
        }
        
        // --- VIEWS & LAYOUT ---

        function renderLoginView() {
            const appRoot = document.getElementById('app-root');
            appRoot.innerHTML = `
                <div class="min-h-screen bg-gray-100 dark:bg-gray-900 flex flex-col justify-center items-center py-12 sm:px-6 lg:px-8">
                    <div class="sm:mx-auto sm:w-full sm:max-w-md text-center">
                        <h2 class="text-3xl font-extrabold text-gray-900 dark:text-white">
                            Welcome Back!
                        </h2>
                        <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                            Sign in to continue to Synapse
                        </p>
                    </div>

                    <div class="mt-8 sm:mx-auto sm:w-full sm:max-w-md">
                        <div class="bg-white dark:bg-gray-800 py-8 px-4 shadow sm:rounded-lg sm:px-10">
                            <div class="space-y-6">
                                <div>
                                    <label for="email" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                        Email address
                                    </label>
                                    <div class="mt-1">
                                        <input id="email" name="email" type="email" autocomplete="email" required class="appearance-none block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    </div>
                                </div>

                                <div>
                                    <label for="password" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                        Password
                                    </label>
                                    <div class="mt-1 relative rounded-md shadow-sm">
                                        <input id="password" name="password" type="password" autocomplete="current-password" required class="appearance-none block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    </div>
                                </div>
                                
                                <div id="auth-error" class="hidden text-sm text-red-500 text-center"></div>

                                <div>
                                    <button id="login-btn" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                        Sign in
                                    </button>
                                </div>

                                <div class="relative">
                                    <div class="absolute inset-0 flex items-center">
                                        <div class="w-full border-t border-gray-300 dark:border-gray-600"></div>
                                    </div>
                                    <div class="relative flex justify-center text-sm">
                                        <span class="px-2 bg-white dark:bg-gray-800 text-gray-500 dark:text-gray-400">
                                        Or continue with
                                        </span>
                                    </div>
                                </div>

                                <div>
                                    <button id="google-signin-btn" class="w-full inline-flex justify-center py-2 px-4 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-sm font-medium text-gray-500 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-600">
                                        <span class="sr-only">Sign in with Google</span>
                                        <svg class="w-5 h-5" aria-hidden="true" fill="currentColor" viewBox="0 0 488 512">
                                            <path d="M488 261.8C488 403.3 381.5 512 244 512 109.8 512 0 402.2 0 261.8 0 120.5 109.8 8.4 244 8.4c74.4 0 134.3 29.4 175.9 68.5l-63.9 62.4c-22.9-21.6-52.6-34.9-88.4-34.9-67.9 0-123.6 55.7-123.6 124.3s55.7 124.3 123.6 124.3c79.2 0 101.9-56.6 105.7-82.4H244V202.9h159.9c1.6 8.7 2.5 17.6 2.5 26.9z"/>
                                        </svg>
                                    </button>
                                </div>


                                <p class="mt-2 text-center text-sm text-gray-600 dark:text-gray-400">
                                    Don't have an account?
                                    <a href="#" id="go-to-signup" class="font-medium text-indigo-600 hover:text-indigo-500">
                                        Sign up
                                    </a>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('login-btn').addEventListener('click', handleLogin);
             document.getElementById('google-signin-btn').addEventListener('click', handleGoogleSignIn);
            document.getElementById('go-to-signup').addEventListener('click', (e) => {
                e.preventDefault();
                renderSignUpView();
            });
        }

        function renderSignUpView() {
            const appRoot = document.getElementById('app-root');
            appRoot.innerHTML = `
                <div class="min-h-screen bg-gray-100 dark:bg-gray-900 flex flex-col justify-center items-center py-12 sm:px-6 lg:px-8">
                    <div class="sm:mx-auto sm:w-full sm:max-w-md text-center">
                        <h2 class="text-3xl font-extrabold text-gray-900 dark:text-white">
                            Create your Account
                        </h2>
                    </div>

                    <div class="mt-8 sm:mx-auto sm:w-full sm:max-w-md">
                        <div class="bg-white dark:bg-gray-800 py-8 px-4 shadow sm:rounded-lg sm:px-10">
                            <div class="space-y-6">
                                <div>
                                    <label for="username" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Username</label>
                                    <div class="mt-1">
                                        <input id="username" name="username" type="text" required class="appearance-none block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    </div>
                                </div>
                                <div>
                                    <label for="email" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Email address</label>
                                    <div class="mt-1">
                                        <input id="email" name="email" type="email" autocomplete="email" required class="appearance-none block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    </div>
                                </div>
                                <div>
                                    <label for="password" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Password</label>
                                    <div class="mt-1">
                                        <input id="password" name="password" type="password" autocomplete="new-password" required class="appearance-none block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    </div>
                                </div>
                                
                                <div id="auth-error" class="hidden text-sm text-red-500 text-center"></div>

                                <div>
                                    <button id="signup-btn" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                        Create Account
                                    </button>
                                </div>

                                 <div class="relative">
                                    <div class="absolute inset-0 flex items-center">
                                        <div class="w-full border-t border-gray-300 dark:border-gray-600"></div>
                                    </div>
                                    <div class="relative flex justify-center text-sm">
                                        <span class="px-2 bg-white dark:bg-gray-800 text-gray-500 dark:text-gray-400">
                                        Or sign up with
                                        </span>
                                    </div>
                                </div>

                                <div>
                                    <button id="google-signin-btn" class="w-full inline-flex justify-center py-2 px-4 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-sm font-medium text-gray-500 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-600">
                                        <span class="sr-only">Sign in with Google</span>
                                        <svg class="w-5 h-5" aria-hidden="true" fill="currentColor" viewBox="0 0 488 512">
                                            <path d="M488 261.8C488 403.3 381.5 512 244 512 109.8 512 0 402.2 0 261.8 0 120.5 109.8 8.4 244 8.4c74.4 0 134.3 29.4 175.9 68.5l-63.9 62.4c-22.9-21.6-52.6-34.9-88.4-34.9-67.9 0-123.6 55.7-123.6 124.3s55.7 124.3 123.6 124.3c79.2 0 101.9-56.6 105.7-82.4H244V202.9h159.9c1.6 8.7 2.5 17.6 2.5 26.9z"/>
                                        </svg>
                                    </button>
                                </div>

                                 <p class="mt-2 text-center text-sm text-gray-600 dark:text-gray-400">
                                    Already have an account?
                                    <a href="#" id="go-to-login" class="font-medium text-indigo-600 hover:text-indigo-500">
                                        Sign in
                                    </a>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('signup-btn').addEventListener('click', handleSignUp);
            document.getElementById('google-signin-btn').addEventListener('click', handleGoogleSignIn);
            document.getElementById('go-to-login').addEventListener('click', (e) => {
                e.preventDefault();
                renderLoginView();
            });
        }

        function renderAppLayout() {
            const appRoot = document.getElementById('app-root');
            const username = userProfile?.username || auth.currentUser?.email;
            appRoot.innerHTML = `
                <div class="flex h-screen bg-gray-100 dark:bg-gray-900 font-sans text-gray-900 dark:text-gray-200">
                    <!-- Sidebar -->
                    <aside class="w-64 flex-shrink-0 bg-white dark:bg-gray-800 border-r dark:border-gray-700 flex flex-col p-4">
                        <div class="h-16 flex items-center px-2 flex-shrink-0">
                            <span class="text-2xl font-bold">Synapse</span>
                        </div>
                        <nav id="main-nav" class="flex flex-col space-y-1 flex-shrink-0">
                            <a href="#" id="nav-my-decks" class="flex items-center px-4 py-2 text-gray-900 dark:text-white bg-gray-100 dark:bg-gray-700 rounded-lg font-semibold">
                                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2h6a2 2 0 012 2v4"></path></svg>
                                My Decks
                            </a>
                            <a href="#" id="nav-progress" class="flex items-center px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg font-medium">
                                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                                Progress
                            </a>
                            <a href="#" id="nav-public-decks" class="flex items-center px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg font-medium">
                                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
                                Public Decks
                            </a>
                             <a href="#" id="nav-profile" class="flex items-center px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg font-medium">
                                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                                Profile
                            </a>
                        </nav>
                        <div class="space-y-2 pt-2 flex-shrink-0">
                            <button id="sidebar-quiz-btn" class="w-full flex items-center justify-center px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700">
                                Quiz
                            </button>
                            <button id="sidebar-add-deck-btn" class="w-full flex items-center justify-center px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">
                                Add Deck
                            </button>
                        </div>
                        <div class="flex-grow pt-4 border-t border-gray-200 dark:border-gray-700 mt-2 flex flex-col min-h-0">
                            <h3 class="px-2 text-sm font-bold text-gray-900 dark:text-white uppercase tracking-wider flex justify-between items-center flex-shrink-0">
                                <span>Library</span>
                                <div class="flex items-center space-x-2">
                                     <button id="library-add-btn" class="text-gray-400 hover:text-gray-600">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                    </button>
                                </div>
                            </h3>
                             <div class="relative mt-2 px-2 flex-shrink-0">
                                <input type="text" id="library-search-input" placeholder="Search..." class="w-full pl-8 pr-2 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 focus:ring-blue-500 focus:border-blue-500">
                                <div class="absolute inset-y-0 left-2 pl-1 flex items-center pointer-events-none">
                                     <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                                </div>
                            </div>
                            <div id="library-list" class="mt-2 space-y-1 flex-grow overflow-y-auto pr-2">
                                <!-- Library items would be dynamically added here -->
                            </div>
                        </div>

                        <!-- User Profile / Logout -->
                        <div class="mt-auto flex-shrink-0 border-t dark:border-gray-700 pt-4">
                            <div class="flex items-center">
                                <div class="flex-1 min-w-0">
                                    <p id="user-display-name" class="text-sm font-medium text-gray-800 dark:text-white truncate" title="${username}">${username}</p>
                                </div>
                                <div class="ml-2 flex-shrink-0">
                                    <button id="logout-btn" title="Logout" class="text-gray-400 hover:text-red-500">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </aside>

                    <div class="flex-1 flex flex-col overflow-hidden">
                        <header class="h-16 bg-white dark:bg-gray-800 border-b dark:border-gray-700 flex items-center justify-between px-6 flex-shrink-0">
                            <div id="main-header">
                                <h1 class="text-xl font-semibold">My Decks</h1>
                            </div>
                            <div class="flex items-center space-x-4">
                                <button id="theme-toggle" type="button" class="text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 rounded-lg text-sm p-2.5">
                                    <svg id="theme-toggle-dark-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                                    <svg id="theme-toggle-light-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.707.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 5.05a1 1 0 010 1.414l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 0zM3 11a1 1 0 100-2H2a1 1 0 100 2h1z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
                                </button>
                            </div>
                        </header>

                        <main id="app-content" class="flex-1 overflow-y-auto p-6"></main>
                    </div>
                </div>

                <!-- Modals container -->
                <div id="modals-container"></div>
            `;
            setupEventListeners();
        }
        
        function renderLibrary(decks, searchTerm = '') {
            const libraryList = document.getElementById('library-list');
            if (!libraryList) return;

            const sortedDecks = decks.sort((a, b) => a.topic.localeCompare(b.topic));
            
             const decksHTML = sortedDecks.map(deck => {
                let topicHTML;
                const escapedTopic = deck.topic.replace(/</g, "&lt;").replace(/>/g, "&gt;");

                if (!searchTerm.trim()) {
                    topicHTML = `<span>${escapedTopic}</span>`;
                } else {
                    const escapedSearchTerm = searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                    const regex = new RegExp(`(${escapedSearchTerm})`, 'gi');
                    topicHTML = escapedTopic.replace(regex, `<strong class="font-bold">$1</strong>`);
                }
                
                return `
                <a href="#" class="flex items-center px-2 py-1 text-sm font-medium text-gray-800 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg" data-id="${deck.id}">
                >&nbsp;${topicHTML}
                </a>
                `;
            }).join('');

            libraryList.innerHTML = decksHTML;
        }

        function renderDecksView(decks) {
            setActiveNav('nav-my-decks');
            const content = document.getElementById('app-content');
            setHeader('My Decks');
            const topicStyles = {
                'Psychology': { color: 'bg-rose-300', icon: '' },
                'Biology': { color: 'bg-orange-400', icon: '' },
                'Chemistry': { color: 'bg-red-400', icon: '' },
                'Physics': { color: 'bg-blue-400', icon: '' },
                'Geography': { color: 'bg-purple-400', icon: '' },
                'English': { color: 'bg-emerald-400', icon: '' },
                'Economics': { color: 'bg-teal-400', icon: '' },
                'Spanish': { color: 'bg-amber-400', icon: '' },
                'History': { color: 'bg-stone-500', icon: '' },
                'Math': { color: 'bg-sky-400', icon: '' },
                'Default': { color: 'bg-gray-400', icon: '' }
            };
            
            const getTopicStyle = (topic) => topicStyles[topic] || topicStyles['Default'];

            if (decks.length === 0) {
                 content.innerHTML = `
                    <div class="text-center py-12">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z" /></svg>
                        <h3 class="mt-2 text-sm font-medium text-gray-900 dark:text-white">No decks</h3>
                        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Get started by creating a new deck.</p>
                        <div class="mt-6">
                            <button id="empty-add-deck-btn" type="button" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                <svg class="-ml-1 mr-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                                New Deck
                            </button>
                        </div>
                    </div>`;
                document.getElementById('empty-add-deck-btn').addEventListener('click', () => renderAddDeckModal());
                return;
            }

            content.innerHTML = `
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                    ${decks.map(deck => {
                        const style = getTopicStyle(deck.topic);
                        const cardCount = deck.cards ? deck.cards.length : 0;
                        const isPublic = deck.isPublic || false;
                        return `
                        <div class="deck-card bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden cursor-pointer transform hover:-translate-y-1 transition-transform duration-200" data-id="${deck.id}">
                            <div class="p-4">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="flex items-center space-x-2">
                                        <div class="w-8 h-8 rounded-lg ${style.color} flex items-center justify-center text-lg">${style.icon}</div>
                                        <h3 class="text-lg font-semibold text-gray-800 dark:text-white">${deck.topic}</h3>
                                    </div>
                                    <div class="flex items-center">
                                         <button class="publish-deck-btn text-gray-400 hover:text-green-500 mr-2" data-id="${deck.id}" data-is-public="${isPublic}">
                                            ${isPublic ? 
                                            `<svg class="w-5 h-5 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM4.332 8.027a6.012 6.012 0 011.912-2.706C6.512 5.72 7 7.92 7 9.5c0 .355.042.709.125 1.055a.8.8 0 01-.84 1.002A5.99 5.99 0 014.002 9.5c0-.99.22-1.93.62-2.775a.795.795 0 01.71-.498zM10 4a6 6 0 00-4.668 9.973.795.795 0 01-.71.498A8.01 8.01 0 012 9.5c0-1.02.213-2 .607-2.887a.8.8 0 011.09-.527A6.009 6.009 0 0110 4zm4.668 5.973a.795.795 0 01.71-.498A8.01 8.01 0 0118 9.5c0-1.02-.213-2-.607-2.887a.8.8 0 01-1.09-.527A6.009 6.009 0 0110 4a6 6 0 00-4.668 9.973.795.795 0 01-.71.498A5.99 5.99 0 0114.002 9.5c0-.99-.22-1.93-.62-2.775a.795.795 0 01.71-.498.8.8 0 01.84 1.002A6.012 6.012 0 0115.668 11.973z" clip-rule="evenodd" />_</svg>` : 
                                            `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-3.333 0-6 2.667-6 4s2.667 4 6 4 6-2.667 6-4-2.667-4-6-4zm0 0V6m0 12v-2m-4-2H4m16 0h-2M6.343 6.343L5.636 5.636m12.728 12.728l-.707-.707M6.343 17.657l-.707.707m12.728-12.728l.707-.707"></path></svg>`}
                                        </button>
                                        <button class="rename-deck-btn text-gray-400 hover:text-blue-500 mr-2" data-id="${deck.id}" data-topic="${deck.topic}">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.732 3.732z"></path></svg>
                                        </button>
                                        <button class="delete-deck-btn text-gray-400 hover:text-red-500" data-id="${deck.id}">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                        </button>
                                    </div>
                                </div>
                                <p class="text-sm text-gray-500 dark:text-gray-400">${cardCount} cards</p>
                            </div>
                        </div>`;
                    }).join('')}
                </div>`;

            document.querySelectorAll('.deck-card').forEach(card => card.addEventListener('click', (e) => {
                if (!e.target.closest('.delete-deck-btn') && !e.target.closest('.rename-deck-btn') && !e.target.closest('.publish-deck-btn')) {
                    viewDeck(card.dataset.id);
                }
            }));
            document.querySelectorAll('.delete-deck-btn').forEach(btn => btn.addEventListener('click', (e) => {
                e.stopPropagation();
                deleteDeck(btn.dataset.id);
            }));
            document.querySelectorAll('.rename-deck-btn').forEach(btn => btn.addEventListener('click', (e) => {
                e.stopPropagation();
                renderRenameDeckModal(btn.dataset.id, btn.dataset.topic);
            }));
             document.querySelectorAll('.publish-deck-btn').forEach(btn => btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const isPublic = btn.dataset.isPublic === 'true';
                if (isPublic) {
                    makeDeckPrivate(btn.dataset.id);
                } else {
                    renderPublishDeckModal(btn.dataset.id);
                }
            }));
        }
        
        async function renderSingleDeckView(deckId) {
            try {
                const deckRef = doc(db, `/artifacts/${appId}/users/${userId}/decks`, deckId);
                const deckSnap = await getDoc(deckRef);
                if (!deckSnap.exists()) {
                    console.error("Deck not found");
                    renderDecksView(allUserDecks);
                    return;
                }
                const deck = { id: deckSnap.id, ...deckSnap.data() };
                const cards = deck.cards || [];
                setHeader(deck.topic);
                
                const content = document.getElementById('app-content');
                content.innerHTML = `
                    <div class="flex flex-col space-y-4">
                       <div class="flex items-center justify-between">
                           <button id="back-to-decks" class="flex items-center text-sm text-blue-600 hover:underline">
                               <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                               Back to My Decks
                           </button>
                           <div class="flex space-x-2">
                               <button id="add-card-btn" class="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-lg hover:bg-green-700">Add Card</button>
                               <button id="start-quiz-btn" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700" ${cards.length === 0 ? 'disabled' : ''}>Start Quiz</button>
                           </div>
                       </div>
                        <div id="card-list" class="bg-white dark:bg-gray-800 rounded-lg shadow">
                            <ul class="divide-y divide-gray-200 dark:divide-gray-700">
                                ${cards.length > 0 ? cards.map((card, index) => `
                                    <li class="p-4 flex items-center justify-between">
                                        <div class="flex-1 mr-4 min-w-0">
                                            <p class="text-sm font-medium text-gray-900 dark:text-white truncate"><strong>Q:</strong> ${card.question}</p>
                                            <p class="text-sm text-gray-500 dark:text-gray-400 truncate"><strong>A:</strong> ${card.answer}</p>
                                        </div>
                                        <div class="flex items-center flex-shrink-0">
                                            <button class="edit-card-btn text-gray-400 hover:text-blue-500 mr-2" data-index="${index}">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.732 3.732z"></path></svg>
                                            </button>
                                            <button class="delete-card-btn text-gray-400 hover:text-red-500" data-index="${index}">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                            </button>
                                        </div>
                                    </li>
                                `).join('') : `<li class="p-6 text-center text-gray-500">No cards in this deck yet.</li>`}
                            </ul>
                        </div>
                    </div>`;

                document.getElementById('back-to-decks').addEventListener('click', () => renderDecksView(allUserDecks));
                document.getElementById('add-card-btn').addEventListener('click', () => renderAddCardModal(deckId));
                document.getElementById('start-quiz-btn').addEventListener('click', () => renderQuizModal(deck));
                
                document.querySelectorAll('.edit-card-btn').forEach(btn => {
                    const cardIndex = parseInt(btn.dataset.index);
                    const cardToEdit = cards[cardIndex];
                    btn.addEventListener('click', () => {
                        renderEditCardModal(deckId, cardIndex, cardToEdit);
                    });
                });

                document.querySelectorAll('.delete-card-btn').forEach(btn => btn.addEventListener('click', () => {
                    deleteCard(deckId, parseInt(btn.dataset.index));
                }));
            } catch (error) {
                console.error("Error fetching single deck:", error);
            }
        }

        function renderProgressView() {
            setActiveNav('nav-progress');
            setHeader('Progress Tracker');
            const content = document.getElementById('app-content');

            content.innerHTML = `
                <div id="progress-view-container">
                    <div id="overall-progress-chart-container" class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow mb-8">
                        <h3 class="text-lg font-semibold mb-4">Overall Subject Progress</h3>
                        <div class="h-64">
                            <canvas id="subjects-progress-chart"></canvas>
                        </div>
                    </div>
                    <div class="flex justify-end mb-4">
                        <button id="add-subject-btn" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700">
                            Add Subject
                        </button>
                    </div>
                    <div id="subject-cards-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Subject cards will be rendered here -->
                    </div>
                </div>
            `;
            
            if (progressSubjects.length === 0) {
                 document.getElementById('subject-cards-container').innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                        <h3 class="mt-2 text-sm font-medium text-gray-900 dark:text-white">No Subjects</h3>
                        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Get started by adding a subject to track.</p>
                        <div class="mt-6">
                            <button id="add-subject-btn-empty" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                                Add Subject
                            </button>
                        </div>
                    </div>`;
                document.getElementById('add-subject-btn-empty').addEventListener('click', renderAddSubjectModal);
                document.getElementById('add-subject-btn').classList.add('hidden');
                document.getElementById('overall-progress-chart-container').classList.add('hidden');
                return;
            }

            drawSubjectsProgressBarChart(progressSubjects);

            const subjectCards = progressSubjects.map(subject => {
                const units = subject.units || [];
                let totalProgress = 0;
                if(units.length > 0) {
                    const unitWeight = 100 / units.length;
                    const totalPoints = units.reduce((sum, unit) => {
                        const topics = unit.topics || [];
                        if (topics.length === 0) return sum;
                        const completed = topics.filter(t => t.done).length;
                        return sum + (completed / topics.length) * unitWeight;
                    }, 0);
                    totalProgress = totalPoints;
                }
                
                return `
                <div class="subject-card bg-white dark:bg-gray-800 rounded-lg shadow p-4 cursor-pointer" data-id="${subject.id}">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-semibold text-lg">${subject.name}</h3>
                            <p class="text-sm text-gray-500">${Math.round(totalProgress)}% Complete</p>
                        </div>
                        <div class="flex items-center">
                            <button class="rename-subject-btn text-gray-400 hover:text-blue-500 mr-2" data-id="${subject.id}" data-name="${subject.name}">
                                 <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.732 3.732z"></path></svg>
                            </button>
                            <button class="delete-subject-btn text-gray-400 hover:text-red-500" data-id="${subject.id}">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
            
            document.getElementById('subject-cards-container').innerHTML = subjectCards;

            document.getElementById('add-subject-btn').addEventListener('click', renderAddSubjectModal);
            document.querySelectorAll('.subject-card').forEach(card => card.addEventListener('click', e => {
                if (!e.target.closest('.delete-subject-btn') && !e.target.closest('.rename-subject-btn')) {
                    renderSingleSubjectView(card.dataset.id);
                }
            }));
            document.querySelectorAll('.delete-subject-btn').forEach(btn => btn.addEventListener('click', e => {
                e.stopPropagation();
                deleteProgressSubject(btn.dataset.id);
            }));
            document.querySelectorAll('.rename-subject-btn').forEach(btn => btn.addEventListener('click', e => {
                e.stopPropagation();
                renderRenameSubjectModal(btn.dataset.id, btn.dataset.name);
            }));
        }

        function renderSingleSubjectView(subjectId) {
            const subject = progressSubjects.find(s => s.id === subjectId);
            if (!subject) {
                renderProgressView();
                return;
            }

            const units = subject.units || [];
            
            let totalProgress = 0;
            if (units.length > 0) {
                const unitWeight = 100 / units.length;
                totalProgress = units.reduce((sum, unit) => {
                    const topics = unit.topics || [];
                    if (topics.length === 0) return sum;
                    const completed = topics.filter(t => t.done).length;
                    return sum + (completed / topics.length) * unitWeight;
                }, 0);
            }
            setHeader(subject.name);
            
            const content = document.getElementById('app-content');
            
            const unitListHTML = units.map((unit, unitIndex) => {
                const topics = unit.topics || [];
                const unitProgress = topics.length > 0 ? (topics.filter(t => t.done).length / topics.length) * 100 : 0;
                const topicItems = topics.map((topic, topicIndex) => `
                    <li class="flex items-center justify-between p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md group">
                        <div class="flex items-center">
                            <input type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 topic-checkbox" data-unit-index="${unitIndex}" data-topic-index="${topicIndex}" ${topic.done ? 'checked' : ''}>
                            <label class="ml-3 text-sm text-gray-800 dark:text-gray-200">${topic.name}</label>
                        </div>
                        <div class="flex items-center opacity-0 group-hover:opacity-100 transition-opacity">
                            <button class="edit-topic-btn text-gray-400 hover:text-blue-500 mr-2" data-unit-index="${unitIndex}" data-topic-index="${topicIndex}">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.732 3.732z"></path></svg>
                            </button>
                            <button class="delete-topic-btn text-gray-400 hover:text-red-500" data-unit-index="${unitIndex}" data-topic-index="${topicIndex}">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </button>
                        </div>
                    </li>
                `).join('');

                return `
                <details class="bg-gray-50 dark:bg-gray-700 rounded-lg" open>
                    <summary class="p-4 cursor-pointer flex justify-between items-center font-semibold">
                        <span>${unit.name}</span>
                        <div class="flex items-center">
                            <span class="text-sm font-medium text-gray-500 dark:text-gray-400 mr-4">${Math.round(unitProgress)}%</span>
                             <button class="rename-unit-btn text-gray-400 hover:text-blue-500 mr-2" data-unit-index="${unitIndex}">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.732 3.732z"></path></svg>
                            </button>
                            <button class="delete-unit-btn text-gray-400 hover:text-red-500" data-unit-index="${unitIndex}">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    </summary>
                    <div class="p-4 border-t dark:border-gray-600">
                        <details class="group" ${topics.length > 0 ? 'open' : ''}>
                            <summary class="list-none cursor-pointer flex justify-between items-center text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white">
                                <span>${topics.length} Topic(s)</span>
                                <svg class="w-4 h-4 transform transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </summary>
                            <ul class="mt-2 space-y-2 mb-4">${topicItems}</ul>
                        </details>
                        <button class="add-topic-to-unit-btn text-sm text-blue-600 hover:underline mt-4" data-unit-index="${unitIndex}">+ Add Topic(s)</button>
                    </div>
                </details>`;
            }).join('');

            content.innerHTML = `
                <div class="flex flex-col gap-8">
                    <div class="flex items-center">
                        <button id="back-to-progress" class="flex items-center text-sm text-blue-600 hover:underline">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                            Back to Subjects
                        </button>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow flex flex-col items-center justify-center">
                         <h3 class="text-lg font-semibold mb-4 text-center">Overall Progress: <span class="text-blue-600 font-bold">${Math.round(totalProgress)}%</span></h3>
                         <div class="w-64 h-64">
                            <canvas id="progress-chart"></canvas>
                         </div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">Units</h3>
                            <button id="add-unit-btn" class="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-lg hover:bg-green-700">Add Unit</button>
                        </div>
                        <div id="unit-list" class="space-y-4">${unitListHTML}</div>
                    </div>
                </div>
            `;
            
            drawUnitBasedPieChart(subject);

            document.getElementById('back-to-progress').addEventListener('click', renderProgressView);
            document.getElementById('add-unit-btn').addEventListener('click', () => renderAddUnitModal(subjectId, units.length));

            document.querySelectorAll('.topic-checkbox').forEach(box => box.addEventListener('change', e => {
                const unitIndex = parseInt(e.target.dataset.unitIndex);
                const topicIndex = parseInt(e.target.dataset.topicIndex);
                updateTopicStatus(subjectId, unitIndex, topicIndex, e.target.checked);
            }));

            document.querySelectorAll('.add-topic-to-unit-btn').forEach(btn => btn.addEventListener('click', e => {
                const unitIndex = parseInt(e.currentTarget.dataset.unitIndex);
                renderAddTopicModal(subjectId, unitIndex);
            }));

            document.querySelectorAll('.rename-unit-btn').forEach(btn => btn.addEventListener('click', e => {
                e.stopPropagation();
                const unitIndex = parseInt(e.currentTarget.dataset.unitIndex);
                renderRenameUnitModal(subjectId, unitIndex, units[unitIndex].name);
            }));
             document.querySelectorAll('.delete-unit-btn').forEach(btn => btn.addEventListener('click', e => {
                e.stopPropagation();
                const unitIndex = parseInt(e.currentTarget.dataset.unitIndex);
                deleteUnit(subjectId, unitIndex);
            }));

            document.querySelectorAll('.edit-topic-btn').forEach(btn => btn.addEventListener('click', e => {
                const unitIndex = parseInt(e.currentTarget.dataset.unitIndex);
                const topicIndex = parseInt(e.currentTarget.dataset.topicIndex);
                renderEditTopicModal(subjectId, unitIndex, topicIndex, units[unitIndex].topics[topicIndex]);
            }));
             document.querySelectorAll('.delete-topic-btn').forEach(btn => btn.addEventListener('click', e => {
                const unitIndex = parseInt(e.currentTarget.dataset.unitIndex);
                const topicIndex = parseInt(e.currentTarget.dataset.topicIndex);
                deleteTopicFromUnit(subjectId, unitIndex, topicIndex);
            }));
        }

        function drawSubjectsProgressBarChart(subjects) {
            const ctx = document.getElementById('subjects-progress-chart');
            if (!ctx) return;

            if (progressChartInstance) {
                progressChartInstance.destroy();
            }

            const subjectNames = subjects.map(s => s.name);
            const subjectProgressData = subjects.map(subject => {
                const units = subject.units || [];
                if (units.length === 0) return 0;
                const unitWeight = 100 / units.length;
                const totalPoints = units.reduce((sum, unit) => {
                    const topics = unit.topics || [];
                    if (topics.length === 0) return sum;
                    const completed = topics.filter(t => t.done).length;
                    return sum + (completed / topics.length) * unitWeight;
                }, 0);
                return totalPoints;
            });

            progressChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: subjectNames,
                    datasets: [{
                        label: 'Progress',
                        data: subjectProgressData,
                        backgroundColor: 'rgba(59, 130, 246, 0.5)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: value => value + "%",
                                color: document.documentElement.classList.contains('dark') ? '#fff' : '#333'
                            },
                            grid: { color: document.documentElement.classList.contains('dark') ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)' },
                        },
                        y: {
                            grid: { display: false },
                            ticks: { color: document.documentElement.classList.contains('dark') ? '#fff' : '#333' }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Progress: ${context.parsed.x.toFixed(1)}%`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function drawUnitBasedPieChart(subject) {
            const units = subject.units || [];
            const ctx = document.getElementById('progress-chart');
            if (!ctx) return;

            if (progressChartInstance) {
                progressChartInstance.destroy();
            }

            if (units.length === 0) {
                ctx.parentElement.innerHTML = `<p class="text-center text-gray-500">Add units and topics to see progress.</p>`;
                return;
            }

            const unitWeight = 100 / units.length;
            
            let totalCompletedPercentage = 0;
            const labels = [];
            const data = [];
            const backgroundColors = [];

            units.forEach((unit, index) => {
                const topics = unit.topics || [];
                const completedTopics = topics.filter(t => t.done).length;
                const unitProgress = topics.length > 0 ? completedTopics / topics.length : 0;
                const weightedProgress = unitProgress * unitWeight;
                
                if(weightedProgress > 0) {
                    labels.push(unit.name);
                    data.push(weightedProgress);
                    backgroundColors.push(`hsl(${(index * 60) % 360}, 70%, 60%)`);
                    totalCompletedPercentage += weightedProgress;
                }
            });

            const remainingPercentage = 100 - totalCompletedPercentage;
            if(remainingPercentage > 0.01) { 
                labels.push('Remaining');
                data.push(remainingPercentage);
                backgroundColors.push(document.documentElement.classList.contains('dark') ? '#374151' : '#e5e7eb');
            }

            progressChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColors,
                        borderColor: document.documentElement.classList.contains('dark') ? '#1f2937' : '#fff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: document.documentElement.classList.contains('dark') ? '#fff' : '#333'
                            }
                        },
                        title: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if(label === 'Remaining') {
                                        return `Remaining: ${context.parsed.toFixed(1)}%`;
                                    }
                                    const unit = units.find(u => u.name === label);
                                    if (unit) {
                                        const topics = unit.topics || [];
                                        const completed = topics.filter(t => t.done).length;
                                        const total = topics.length;
                                        const percentage = total > 0 ? (completed / total) * 100 : 0;
                                        return `${label}: ${percentage.toFixed(1)}% complete`;
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderQuizModal(deck) {
            let currentCardIndex = 0;
            
            const modalContent = `
                <div id="quiz-content" class="h-96 flex flex-col items-center justify-center">
                    <!-- Card will be rendered here -->
                </div>
            `;

            renderModal('quiz-modal', `${deck.topic} Quiz`, modalContent, () => {}, '');
            // Hide default save/cancel buttons for quiz
            const quizModal = document.getElementById('quiz-modal');
            quizModal.querySelector('#modal-save-btn').style.display = 'none';
            quizModal.querySelector('.modal-close-btn').style.display = 'none'; // Hide cancel button in footer too
            
            function showCard(index) {
                const quizContent = document.getElementById('quiz-content');
                if (!deck.cards || index >= deck.cards.length) {
                    quizContent.innerHTML = `<div class="text-center">
                        <h2 class="text-2xl font-bold mb-4">Quiz Complete!</h2>
                        <button id="quiz-close-btn-final" class="px-4 py-2 text-white bg-blue-600 rounded-lg">Close Quiz</button>
                    </div>`;
                     document.getElementById('quiz-close-btn-final').addEventListener('click', () => document.getElementById('quiz-modal').remove());
                    return;
                }

                const cardData = deck.cards[index];
                quizContent.innerHTML = `
                    <p class="text-sm text-gray-500 mb-2">${index + 1} / ${deck.cards.length}</p>
                    <div class="scene w-full h-64">
                        <div id="quiz-card" class="card relative w-full h-full cursor-pointer">
                            <div class="card-face absolute w-full h-full flex items-center justify-center p-6 bg-white dark:bg-gray-700 rounded-lg shadow-lg">
                                <p class="text-xl text-center">${cardData.question}</p>
                            </div>
                            <div class="card-face card-face-back absolute w-full h-full flex items-center justify-center p-6 bg-blue-100 dark:bg-blue-900 rounded-lg shadow-lg">
                                 <p class="text-xl text-center font-semibold">${cardData.answer}</p>
                            </div>
                        </div>
                    </div>
                     <div id="explain-btn-container" class="h-12 mt-4 flex justify-center items-center">
                        <!-- Explain button will be dynamically added here -->
                    </div>
                    <div class="mt-2 flex items-center justify-center space-x-4">
                        <button id="prev-card-btn" class="px-6 py-2 rounded-lg bg-gray-200 dark:bg-gray-600" ${index === 0 ? 'disabled' : ''}>Previous</button>
                        <button id="flip-card-btn" class="px-6 py-2 rounded-lg bg-gray-200 dark:bg-gray-600">Flip</button>
                        <button id="next-card-btn" class="px-6 py-2 rounded-lg bg-blue-600 text-white">Next</button>
                    </div>
                `;

                const cardElement = document.getElementById('quiz-card');
                const explainContainer = document.getElementById('explain-btn-container');
                
                function flipCard() {
                    cardElement.classList.toggle('is-flipped');
                     if (cardElement.classList.contains('is-flipped')) {
                        explainContainer.innerHTML = `
                            <button id="explain-card-btn" class="px-4 py-2 text-sm rounded-lg bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 flex items-center">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a2 2 0 01-2-2V10a2 2 0 012-2h8z"></path></svg>
                                Explain
                            </button>`;
                        document.getElementById('explain-card-btn').addEventListener('click', (e) => {
                            e.stopPropagation(); // Prevent quiz modal from handling this click
                            renderChatbotModal(cardData);
                        });
                    } else {
                        explainContainer.innerHTML = '';
                    }
                }

                cardElement.addEventListener('click', flipCard);
                document.getElementById('flip-card-btn').addEventListener('click', flipCard);
                
                document.getElementById('next-card-btn').addEventListener('click', () => {
                    currentCardIndex++;
                    showCard(currentCardIndex);
                });

                const prevButton = document.getElementById('prev-card-btn');
                if(prevButton) {
                    prevButton.addEventListener('click', () => {
                        currentCardIndex--;
                        showCard(currentCardIndex);
                    });
                }
            }

            showCard(currentCardIndex);
        }
        
        function renderQuizSelectionModal(decks) {
            const modalContent = `
                <div id="quiz-deck-selection" class="space-y-2">
                    ${decks.map(deck => `
                        <button class="w-full text-left p-3 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600" data-deck-id="${deck.id}">
                            ${deck.topic}
                        </button>
                    `).join('')}
                </div>
            `;
            renderModal('quiz-selection-modal', 'Select a Deck to Quiz', modalContent, () => {}, '');
            const selectionModal = document.getElementById('quiz-selection-modal');
            selectionModal.querySelector('#modal-save-btn').style.display = 'none'; // Hide footer buttons
            selectionModal.querySelector('.modal-close-btn').style.display = 'none';

            document.getElementById('quiz-deck-selection').addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (button && button.dataset.deckId) {
                    const deckId = button.dataset.deckId;
                    const selectedDeck = decks.find(d => d.id === deckId);
                    if (selectedDeck) {
                        selectionModal.remove();
                        if (selectedDeck.cards && selectedDeck.cards.length > 0) {
                            renderQuizModal(selectedDeck);
                        } else {
                            alert('This deck has no cards to quiz!');
                        }
                    }
                }
            });
        }
        
        function renderChatbotModal(cardData) {
            chatHistory = []; // Reset history for each new chat

            const modalContent = `
                <div class="flex flex-col h-[60vh]">
                    <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4">
                        <!-- Chat messages will be rendered here -->
                    </div>
                    <div class="p-4 border-t dark:border-gray-700 flex items-center">
                        <input type="text" id="chat-input" class="flex-1 px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Ask a follow-up question...">
                        <button id="chat-send-btn" class="ml-2 px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700">
                            Send
                        </button>
                    </div>
                </div>
            `;
            
            renderModal('chatbot-modal', 'AI Tutor', modalContent, () => {}, '');
            const chatbotModal = document.getElementById('chatbot-modal');
            chatbotModal.querySelector('#modal-save-btn').style.display = 'none';
            chatbotModal.querySelector('.modal-close-btn:not(h3 ~ .modal-close-btn)').style.display = 'none'; // Hide footer cancel button

            const chatInput = document.getElementById('chat-input');
            const chatSendBtn = document.getElementById('chat-send-btn');
            
            chatSendBtn.addEventListener('click', handleUserMessage);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleUserMessage();
                }
            });

            // Start the conversation
            const initialPrompt = `Explain this to me in simple terms. Question: "${cardData.question}", Answer: "${cardData.answer}"`;
            addUserMessageToChat(initialPrompt, true); // Add user message visually but hide it
            getAIResponse(initialPrompt);
        }
        
        function setHeader(title) {
            const header = document.getElementById('main-header');
            if(header) header.innerHTML = `<h1 class="text-xl font-semibold">${title}</h1>`;
        }

        function setActiveNav(activeId) {
            const nav = document.getElementById('main-nav');
            nav.querySelectorAll('a').forEach(link => {
                if (link.id === activeId) {
                    link.classList.add('text-gray-900', 'dark:text-white', 'bg-gray-100', 'dark:bg-gray-700', 'font-semibold');
                    link.classList.remove('text-gray-600', 'dark:text-gray-400', 'font-medium');
                } else {
                    link.classList.remove('text-gray-900', 'dark:text-white', 'bg-gray-100', 'dark:bg-gray-700', 'font-semibold');
                    link.classList.add('text-gray-600', 'dark:text-gray-400', 'font-medium');
                }
            });
        }

        // --- AUTHENTICATION LOGIC ---

        function showAuthError(message) {
            const errorDiv = document.getElementById('auth-error');
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.classList.remove('hidden');
            }
        }

        async function createUserProfile(user, username) {
             await setDoc(doc(db, `/artifacts/${appId}/users/${user.uid}/profile`, 'details'), {
                username: username,
                following: 0,
                followers: 0
            });
        }

        async function handleSignUp() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const username = document.getElementById('username').value;
            if (!email || !password || !username) {
                showAuthError("Please fill out all fields.");
                return;
            }
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await createUserProfile(userCredential.user, username);
            } catch (error) {
                 if (error.code === 'auth/email-already-in-use') {
                    showAuthError('An account with this email already exists.');
                } else if (error.code === 'auth/weak-password') {
                    showAuthError('Password should be at least 6 characters.');
                } else {
                    showAuthError('An error occurred during sign up.');
                }
                console.error("Sign up error:", error);
            }
        }

        async function handleLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
             if (!email || !password) {
                showAuthError("Please enter both email and password.");
                return;
            }
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                if (error.code === 'auth/invalid-credential' || error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    showAuthError('Invalid email or password.');
                } else {
                    showAuthError('An error occurred. Please try again.');
                }
                console.error("Login error:", error);
            }
        }

        async function handleGoogleSignIn() {
            const provider = new GoogleAuthProvider();
            try {
                const result = await signInWithPopup(auth, provider);
                const user = result.user;

                // Check if user is new, if so, create a profile
                const profileRef = doc(db, `/artifacts/${appId}/users/${user.uid}/profile`, 'details');
                const profileSnap = await getDoc(profileRef);

                if (!profileSnap.exists()) {
                    await createUserProfile(user, user.displayName);
                }

            } catch (error) {
                console.error("Google Sign-in Error:", error);
                showAuthError("Could not sign in with Google. Please try again.");
            }
        }
        
        async function handleLogout() {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Logout error:", error);
            }
        }

        // --- DATA LOGIC ---
        
        async function updateUserProfile(newUsername) {
            if (!userId || !newUsername) return;
            try {
                const profileRef = doc(db, `/artifacts/${appId}/users/${userId}/profile`, 'details');
                // Use setDoc with merge:true to create or update the document.
                await setDoc(profileRef, { username: newUsername }, { merge: true });
            } catch (error) {
                console.error("Error updating user profile:", error);
            }
        }

        async function createDeck(topic) {
            try {
                const decksCol = collection(db, `/artifacts/${appId}/users/${userId}/decks`);
                await addDoc(decksCol, { topic, cards: [], isPublic: false });
            } catch (error) {
                console.error("Error creating deck:", error);
            }
        }
        
        async function updateDeckTopic(deckId, newTopic) {
            try {
                const deckRef = doc(db, `/artifacts/${appId}/users/${userId}/decks`, deckId);
                await updateDoc(deckRef, {
                    topic: newTopic
                });
            } catch (error) {
                console.error("Error renaming deck:", error);
            }
        }

        async function deleteDeck(deckId) {
            if (confirm('Are you sure you want to delete this deck and all its cards?')) {
                try {
                    const deckRef = doc(db, `/artifacts/${appId}/users/${userId}/decks`, deckId);
                    // Also delete from public collection if it exists
                    const publicDeckQuery = query(collection(db, `artifacts/${appId}/public_decks`), where("originalDeckId", "==", deckId), where("ownerId", "==", userId));
                    const publicDeckSnapshot = await getDocs(publicDeckQuery);
                    const batch = writeBatch(db);
                    publicDeckSnapshot.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    batch.delete(deckRef);
                    await batch.commit();

                } catch (error) {
                    console.error("Error deleting deck:", error);
                }
            }
        }

        async function addMultipleCardsToDeck(deckId, newCards) {
            try {
                const deckRef = doc(db, `/artifacts/${appId}/users/${userId}/decks`, deckId);
                const deckSnap = await getDoc(deckRef);
                if (deckSnap.exists()) {
                    const deck = deckSnap.data();
                    const existingCards = deck.cards || [];
                    const updatedCards = [...existingCards, ...newCards];
                    await updateDoc(deckRef, { cards: updatedCards });
                    renderSingleDeckView(deckId); // Refresh view
                }
            } catch (error) {
                console.error("Error adding multiple cards:", error);
            }
        }

        async function updateCard(deckId, cardIndex, newQuestion, newAnswer) {
            try {
                const deckRef = doc(db, `/artifacts/${appId}/users/${userId}/decks`, deckId);
                const deckSnap = await getDoc(deckRef);
                if (deckSnap.exists()) {
                    const deck = deckSnap.data();
                    const updatedCards = [...deck.cards]; // Create a copy
                    updatedCards[cardIndex] = { question: newQuestion, answer: newAnswer };
                    await updateDoc(deckRef, { cards: updatedCards });
                    renderSingleDeckView(deckId); // Refresh view
                }
            } catch (error) {
                console.error("Error updating card:", error);
            }
        }

        async function deleteCard(deckId, cardIndex) {
            try {
                const deckRef = doc(db, `/artifacts/${appId}/users/${userId}/decks`, deckId);
                const deckSnap = await getDoc(deckRef);
                if (deckSnap.exists()) {
                    const deck = deckSnap.data();
                    const updatedCards = deck.cards.filter((_, index) => index !== cardIndex);
                    await updateDoc(deckRef, { cards: updatedCards });
                    renderSingleDeckView(deckId); // Refresh view
                }
            } catch (error) {
                console.error("Error deleting card:", error);
            }
        }
        
        // --- AI Generation & Chatbot Logic ---

        function formatAIResponse(text) {
            // Replace **text** with <strong>text</strong>
            let formattedText = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // Split text into paragraphs based on double newlines
            const paragraphs = formattedText.split(/\n\s*\n/);

            return paragraphs.map(para => {
                const lines = para.split('\n');
                // Check if all non-empty lines in the paragraph start with '* '
                const isList = lines.filter(line => line.trim() !== '').every(line => line.trim().startsWith('* '));

                if (isList && lines.length > 0) {
                    const listItems = lines.map(line => `<li>${line.trim().substring(2).trim()}</li>`).join('');
                    return `<ul class="list-disc list-inside space-y-2 my-2">${listItems}</ul>`;
                } else {
                    // It's a regular paragraph, just join lines with line breaks and wrap in a p tag
                    return `<p>${para.replace(/\n/g, '<br>')}</p>`;
                }
            }).join('');
        }

        function addUserMessageToChat(message, isHidden = false) {
            const chatMessages = document.getElementById('chat-messages');
            if (chatMessages && !isHidden) {
                const messageEl = document.createElement('div');
                messageEl.className = 'flex justify-end';
                messageEl.innerHTML = `<div class="bg-blue-500 text-white p-3 rounded-lg max-w-xs">${message}</div>`;
                chatMessages.appendChild(messageEl);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            chatHistory.push({ role: 'user', parts: [{ text: message }] });
        }

        function addBotMessageToChat(message) {
            const chatMessages = document.getElementById('chat-messages');
            if (chatMessages) {
                 // Remove any existing loader
                const existingLoader = chatMessages.querySelector('.loader-container');
                if (existingLoader) existingLoader.remove();

                const formattedMessage = formatAIResponse(message);
                const messageEl = document.createElement('div');
                messageEl.className = 'flex justify-start';
                messageEl.innerHTML = `<div class="bg-gray-200 dark:bg-gray-600 p-3 rounded-lg max-w-xs text-sm">${formattedMessage}</div>`;
                chatMessages.appendChild(messageEl);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            chatHistory.push({ role: 'model', parts: [{ text: message }] });
        }
        
        function addBotLoader() {
            const chatMessages = document.getElementById('chat-messages');
            if (chatMessages) {
                const loaderEl = document.createElement('div');
                loaderEl.className = 'flex justify-start loader-container';
                loaderEl.innerHTML = `<div class="bg-gray-200 dark:bg-gray-600 p-3 rounded-lg max-w-xs"><div class="loader" style="width:20px; height:20px;"></div></div>`;
                chatMessages.appendChild(loaderEl);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }

        async function handleUserMessage() {
            const chatInput = document.getElementById('chat-input');
            const message = chatInput.value.trim();
            if (message) {
                addUserMessageToChat(message);
                chatInput.value = '';
                await getAIResponse(message);
            }
        }

        async function getAIResponse(prompt) {
            addBotLoader();
            try {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${geminiApiKey}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: chatHistory, // Send the whole history
                        systemInstruction: {
                            parts: [{ text: "You are a Gen-Z AI tutor. Your vibe is super chill and helpful. Explain things, but make it quick and snappy, like 1-2 sentences. Use modern slang like 'bet,' 'low-key,' 'vibe,' 'slay,' or 'it's giving...'. Keep it friendly and not cringe. The goal is to make learning feel like a quick chat with a friend." }]
                        },
                    })
                });

                if (!response.ok) throw new Error(`API error: ${response.status}`);
                
                const result = await response.json();
                const botResponse = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (botResponse) {
                    addBotMessageToChat(botResponse);
                } else {
                    addBotMessageToChat("I'm not sure how to respond to that. Could you ask in a different way?");
                }

            } catch (error) {
                console.error("AI chat error:", error);
                addBotMessageToChat("Sorry, I encountered an error. Please try again.");
            }
        }

        async function generateCardsWithAI(deckId) {
            const topicInput = document.getElementById('ai-topic-input');
            const cardCountInput = document.getElementById('ai-card-count');
            const loader = document.getElementById('ai-loader');
            const text = topicInput.value.trim();
            const cardCount = cardCountInput ? parseInt(cardCountInput.value, 10) : 8;

            if (!text) {
                alert("Please enter a topic or some notes for the AI.");
                return;
            }

            loader.classList.remove('hidden');
            const saveButton = document.getElementById('modal-save-btn');
            saveButton.disabled = true;

            const prompt = `
                You are an expert flashcard creator. Based on the following topic or notes, generate a list of exactly ${cardCount} flashcards.
                The response MUST be a valid JSON array of objects, where each object has a "question" and an "answer" key.
                Do NOT include any other text, explanations, or markdown formatting.
                The questions should be clear and concise. The answers should be accurate and to the point.
                Topic/Notes:
                ---
                ${text}
                ---
            `;

            try {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${geminiApiKey}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                         generationConfig: {
                            // Enforce JSON output
                            responseMimeType: "application/json",
                        }
                    })
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    throw new Error(`API error: ${response.status} - ${errorBody}`);
                }

                const result = await response.json();
                const aiResponseText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!aiResponseText) {
                    throw new Error("The AI returned an empty response.");
                }
                
                const newCards = JSON.parse(aiResponseText);

                if (Array.isArray(newCards) && newCards.length > 0) {
                    await addMultipleCardsToDeck(deckId, newCards);
                    document.getElementById('add-card-modal')?.remove();
                } else {
                    throw new Error("The AI did not return a valid array of cards.");
                }

            } catch (error) {
                console.error("Error generating cards with AI:", error);
                alert(`Failed to generate cards. Please try again. Error: ${error.message}`);
            } finally {
                loader.classList.add('hidden');
                saveButton.disabled = false;
            }
        }

        async function generateSummaryWithAI(cards) {
            const cardContent = cards.slice(0, 10).map(c => `Q: ${c.question}\nA: ${c.answer}`).join('\n\n'); // Use up to 10 cards for summary
            const prompt = `Based on the following flashcards, generate a concise, one-sentence summary for the deck that would be appealing to other students:\n\n${cardContent}`;

            try {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${geminiApiKey}`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });

                if (!response.ok) throw new Error(`API call failed with status: ${response.status}`);

                const result = await response.json();
                const summary = result.candidates?.[0]?.content?.parts?.[0]?.text || "A collection of flashcards.";
                return summary.trim().replace(/"/g, ''); // Remove quotes from summary

            } catch (error) {
                console.error("AI summary generation failed:", error);
                return "A helpful collection of flashcards."; // Return a default summary on error
            }
        }
        
        // --- Progress Feature Data Logic ---
        async function addProgressSubject(name) {
            try {
                const subjectsCol = collection(db, `/artifacts/${appId}/users/${userId}/progress_subjects`);
                await addDoc(subjectsCol, { name, units: [] });
            } catch(e) { console.error("Error adding subject: ", e); }
        }

        async function updateSubjectName(subjectId, newName) {
            try {
                const subjectRef = doc(db, `/artifacts/${appId}/users/${userId}/progress_subjects`, subjectId);
                await updateDoc(subjectRef, { name: newName });
            } catch(e) { console.error("Error renaming subject: ", e); }
        }

        async function deleteProgressSubject(subjectId) {
            if (confirm('Are you sure you want to delete this subject and all its topics?')) {
                try {
                    const subjectRef = doc(db, `/artifacts/${appId}/users/${userId}/progress_subjects`, subjectId);
                    await deleteDoc(subjectRef);
                } catch (e) { console.error("Error deleting subject: ", e); }
            }
        }

        async function addMultipleUnitsToSubject(subjectId, newUnits) {
            try {
                const subjectRef = doc(db, `/artifacts/${appId}/users/${userId}/progress_subjects`, subjectId);
                const docSnap = await getDoc(subjectRef);
                if (docSnap.exists()) {
                    const existingUnits = docSnap.data().units || [];
                    const updatedUnits = [...existingUnits, ...newUnits];
                    await updateDoc(subjectRef, { units: updatedUnits });
                }
            } catch(e) { console.error("Error adding units: ", e); }
        }

        async function updateUnitName(subjectId, unitIndex, newName) {
            try {
                const subjectRef = doc(db, `/artifacts/${appId}/users/${userId}/progress_subjects`, subjectId);
                const docSnap = await getDoc(subjectRef);
                if (docSnap.exists()) {
                    const units = docSnap.data().units || [];
                    if (units[unitIndex]) {
                        units[unitIndex].name = newName;
                        await updateDoc(subjectRef, { units: units });
                    }
                }
            } catch(e) { console.error("Error updating unit name: ", e); }
        }

        async function deleteUnit(subjectId, unitIndex) {
            if (confirm('Are you sure you want to delete this unit and all its topics?')) {
                try {
                    const subjectRef = doc(db, `/artifacts/${appId}/users/${userId}/progress_subjects`, subjectId);
                    const docSnap = await getDoc(subjectRef);
                    if (docSnap.exists()) {
                        const units = docSnap.data().units || [];
                        const updatedUnits = units.filter((_, index) => index !== unitIndex);
                        await updateDoc(subjectRef, { units: updatedUnits });
                    }
                } catch(e) { console.error("Error deleting unit: ", e); }
            }
        }


        async function addMultipleTopicsToUnit(subjectId, unitIndex, topicNames) {
            try {
                const subjectRef = doc(db, `/artifacts/${appId}/users/${userId}/progress_subjects`, subjectId);
                const docSnap = await getDoc(subjectRef);
                if (docSnap.exists()) {
                    const units = docSnap.data().units || [];
                    if (units[unitIndex]) {
                        const currentTopics = units[unitIndex].topics || [];
                        const newTopics = topicNames.map(name => ({ name, done: false }));
                        units[unitIndex].topics = [...currentTopics, ...newTopics];
                        await updateDoc(subjectRef, { units: units });
                    }
                }
            } catch(e) { console.error("Error adding topics: ", e); }
        }

         async function updateTopicName(subjectId, unitIndex, topicIndex, newName) {
            try {
                const subjectRef = doc(db, `/artifacts/${appId}/users/${userId}/progress_subjects`, subjectId);
                const docSnap = await getDoc(subjectRef);
                if (docSnap.exists()) {
                    const units = docSnap.data().units || [];
                    if (units[unitIndex]?.topics[topicIndex]) {
                        units[unitIndex].topics[topicIndex].name = newName;
                        await updateDoc(subjectRef, { units: units });
                    }
                }
            } catch(e) { console.error("Error updating topic name: ", e); }
        }

        async function updateTopicStatus(subjectId, unitIndex, topicIndex, isDone) {
             try {
                const subjectRef = doc(db, `/artifacts/${appId}/users/${userId}/progress_subjects`, subjectId);
                const docSnap = await getDoc(subjectRef);
                if (docSnap.exists()) {
                    const units = docSnap.data().units || [];
                     if (units[unitIndex]?.topics[topicIndex]) {
                        units[unitIndex].topics[topicIndex].done = isDone;
                        await updateDoc(subjectRef, { units: units });
                    }
                }
            } catch(e) { console.error("Error updating topic status: ", e); }
        }
        
        async function deleteTopicFromUnit(subjectId, unitIndex, topicIndex) {
            try {
                const subjectRef = doc(db, `/artifacts/${appId}/users/${userId}/progress_subjects`, subjectId);
                const docSnap = await getDoc(subjectRef);
                if (docSnap.exists()) {
                   const units = docSnap.data().units || [];
                     if (units[unitIndex]) {
                        units[unitIndex].topics = units[unitIndex].topics.filter((_, index) => index !== topicIndex);
                        await updateDoc(subjectRef, { units: units });
                    }
                }
            } catch(e) { console.error("Error deleting topic: ", e); }
        }
        
        // --- Public Decks Logic ---
        async function makeDeckPublic(deckId, summary) {
            try {
                const privateDeckRef = doc(db, `/artifacts/${appId}/users/${userId}/decks`, deckId);
                const privateDeckSnap = await getDoc(privateDeckRef);

                if (privateDeckSnap.exists()) {
                    const deckData = privateDeckSnap.data();
                    const publicDecksCol = collection(db, `artifacts/${appId}/public_decks`);
                    
                    const batch = writeBatch(db);
                    
                    // Add to public collection
                    const newPublicDeckRef = doc(publicDecksCol); // Auto-generate ID
                    batch.set(newPublicDeckRef, {
                        topic: deckData.topic,
                        summary: summary,
                        cards: deckData.cards,
                        ownerId: userId,
                        originalDeckId: deckId,
                    });

                    // Update private deck status
                    batch.update(privateDeckRef, { isPublic: true });
                    
                    await batch.commit();
                    alert('Deck published successfully!');
                }
            } catch(e) {
                console.error("Error making deck public: ", e);
                alert('Failed to publish deck.');
            } finally {
                fetchAndDisplayDecks(); // Force re-render regardless of success or failure
            }
        }

        async function updatePublicDeckSummary(publicDeckId, newSummary) {
            try {
                const publicDeckRef = doc(db, `artifacts/${appId}/public_decks`, publicDeckId);
                await updateDoc(publicDeckRef, {
                    summary: newSummary
                });
                alert('Summary updated successfully!');
            } catch (e) {
                console.error("Error updating summary:", e);
                alert('Failed to update summary.');
            }
        }

        async function makeDeckPrivate(deckId) {
            if (!confirm('Are you sure you want to make this deck private? Others will no longer be able to see it.')) return;
            try {
                const publicDeckQuery = query(collection(db, `artifacts/${appId}/public_decks`), where("originalDeckId", "==", deckId), where("ownerId", "==", userId));
                const publicDeckSnapshot = await getDocs(publicDeckQuery);
                
                const batch = writeBatch(db);
                
                publicDeckSnapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });

                const privateDeckRef = doc(db, `/artifacts/${appId}/users/${userId}/decks`, deckId);
                batch.update(privateDeckRef, { isPublic: false });
                
                await batch.commit();
                alert('Deck is now private.');

            } catch(e) {
                console.error("Error making deck private: ", e);
                alert('Failed to make deck private.');
            } finally {
                fetchAndDisplayDecks(); // Force re-render
            }
        }

        async function importPublicDeck(publicDeckId) {
            try {
                const publicDeckRef = doc(db, `artifacts/${appId}/public_decks`, publicDeckId);
                const publicDeckSnap = await getDoc(publicDeckRef);

                if (publicDeckSnap.exists()) {
                    const deckData = publicDeckSnap.data();
                    
                    // Prevent importing own deck
                    if (deckData.ownerId === userId) {
                        alert("You cannot import your own deck.");
                        return;
                    }
                    
                    const privateDecksCol = collection(db, `/artifacts/${appId}/users/${userId}/decks`);
                    await addDoc(privateDecksCol, {
                        topic: `${deckData.topic} (Imported)`,
                        cards: deckData.cards,
                        isPublic: false, // Imported decks are private by default
                        summary: deckData.summary || ''
                    });

                    alert('Deck imported successfully!');
                }
            } catch (e) {
                console.error("Error importing deck:", e);
                alert('Failed to import deck.');
            }
        }

        async function renderPublicDecksView() {
            setActiveNav('nav-public-decks');
            setHeader('Public Decks');
            const content = document.getElementById('app-content');
            content.innerHTML = `<div class="text-center text-gray-500">Loading public decks...</div>`;
            
            try {
                const publicDecksCol = collection(db, `artifacts/${appId}/public_decks`);
                const snapshot = await getDocs(publicDecksCol);
                allPublicDecks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                displayPublicDecks(allPublicDecks);

            } catch(e) {
                 console.error("Error fetching public decks: ", e);
                 content.innerHTML = `<div class="text-center text-red-500">Failed to load public decks.</div>`;
            }
        }
        
        function displayPublicDecks(decksToDisplay) {
            const content = document.getElementById('app-content');

             if (allPublicDecks.length === 0 && decksToDisplay.length === 0) {
                content.innerHTML = `
                    <div class="text-center py-12">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                        <h3 class="mt-2 text-sm font-medium text-gray-900 dark:text-white">No Public Decks Yet</h3>
                        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Be the first to share a deck!</p>
                    </div>`;
                return;
            }
            
            const searchBarHTML = `
                <div class="mb-6 relative">
                    <input type="text" id="public-deck-search" placeholder="Search by topic or summary..." class="w-full pl-10 pr-4 py-2 border dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 focus:ring-blue-500 focus:border-blue-500">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                         <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </div>
                </div>`;

             const deckCardsHTML = decksToDisplay.map(deck => {
                 const cardCount = deck.cards ? deck.cards.length : 0;
                 const canImport = deck.ownerId !== userId;
                 const summary = deck.summary || 'No summary provided.';
                 return `
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden flex flex-col">
                        <div class="p-4 flex-grow cursor-pointer public-deck-card" data-id="${deck.id}">
                            <h3 class="text-lg font-semibold text-gray-800 dark:text-white truncate">${deck.topic}</h3>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">${cardCount} cards</p>
                            <p class="text-sm text-gray-600 dark:text-gray-300 mt-2 h-10 overflow-hidden text-ellipsis">${summary}</p>
                            <p class="text-xs text-gray-400 mt-2">By: <span class="font-mono">${deck.ownerId.substring(0,8)}...</span></p>
                        </div>
                        <div class="p-4 border-t dark:border-gray-700">
                            <button class="import-deck-btn w-full px-4 py-2 text-sm font-medium rounded-lg ${canImport ? 'text-white bg-blue-600 hover:bg-blue-700' : 'text-gray-400 bg-gray-200 dark:bg-gray-700 cursor-not-allowed'}" data-id="${deck.id}" ${!canImport ? 'disabled' : ''}>
                                ${canImport ? 'Import to My Decks' : 'Your Deck'}
                            </button>
                        </div>
                    </div>`;
             }).join('');

             content.innerHTML = `${searchBarHTML}<div id="public-decks-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">${deckCardsHTML}</div>`;

            document.getElementById('public-deck-search').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const currentSearchValue = e.target.value;
                const filteredDecks = allPublicDecks.filter(deck => 
                    deck.topic.toLowerCase().includes(searchTerm) || 
                    (deck.summary && deck.summary.toLowerCase().includes(searchTerm))
                );
                displayPublicDecks(filteredDecks); // This re-renders the whole view
                const searchInput = document.getElementById('public-deck-search');
                if(searchInput) {
                    searchInput.value = currentSearchValue; // Restore search term
                    searchInput.focus(); // Restore focus
                }
            });

            document.querySelectorAll('.public-deck-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    renderPublicDeckDetailView(e.currentTarget.dataset.id);
                });
            });
            
             document.querySelectorAll('.import-deck-btn').forEach(btn => btn.addEventListener('click', (e) => {
                 e.stopPropagation();
                 importPublicDeck(e.currentTarget.dataset.id);
             }));
        }

        async function renderPublicDeckDetailView(publicDeckId) {
            setHeader('View Public Deck');
            const content = document.getElementById('app-content');
            content.innerHTML = `<div class="text-center text-gray-500">Loading deck...</div>`;

            try {
                const publicDeckRef = doc(db, `artifacts/${appId}/public_decks`, publicDeckId);
                const publicDeckSnap = await getDoc(publicDeckRef);

                if (!publicDeckSnap.exists()) {
                    content.innerHTML = `<div class="text-center text-red-500">Could not find this public deck.</div>`;
                    return;
                }

                const deck = { id: publicDeckSnap.id, ...publicDeckSnap.data() };
                const cards = deck.cards || [];
                const summary = deck.summary || 'No summary provided.';
                setHeader(`Viewing: ${deck.topic}`);

                const canImport = deck.ownerId !== userId;
                const isOwner = !canImport;

                content.innerHTML = `
                    <div class="flex flex-col space-y-4">
                       <div class="flex items-center justify-between">
                           <button id="back-to-public-decks" class="flex items-center text-sm text-blue-600 hover:underline">
                               <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                               Back to Public Decks
                           </button>
                           <div class="flex space-x-2">
                               <button id="import-deck-btn-detail" class="px-4 py-2 text-sm font-medium rounded-lg ${canImport ? 'text-white bg-blue-600 hover:bg-blue-700' : 'text-gray-400 bg-gray-200 dark:bg-gray-700 cursor-not-allowed'}" ${!canImport ? 'disabled' : ''}>
                                   ${canImport ? 'Import to My Decks' : 'This is Your Deck'}
                               </button>
                               <button id="start-quiz-btn" class="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-lg hover:bg-green-700" ${cards.length === 0 ? 'disabled' : ''}>
                                   Start Quiz
                               </button>
                           </div>
                       </div>
                       <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
                            <h4 class="font-semibold mb-2">Summary</h4>
                            ${isOwner ? `
                                <textarea id="summary-edit-textarea" class="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600" rows="3">${summary}</textarea>
                                <button id="save-summary-btn" class="mt-2 px-3 py-1 bg-green-600 text-white text-sm rounded-md hover:bg-green-700">Save Summary</button>
                            ` : `
                                <p class="text-sm text-gray-600 dark:text-gray-300">${summary}</p>
                            `}
                       </div>
                        <div id="card-list" class="bg-white dark:bg-gray-800 rounded-lg shadow">
                            <ul class="divide-y divide-gray-200 dark:divide-gray-700">
                                ${cards.length > 0 ? cards.map((card) => `
                                    <li class="p-4 flex items-center justify-between">
                                        <div class="flex-1 mr-4 min-w-0">
                                            <p class="text-sm font-medium text-gray-900 dark:text-white truncate"><strong>Q:</strong> ${card.question}</p>
                                            <p class="text-sm text-gray-500 dark:text-gray-400 truncate"><strong>A:</strong> ${card.answer}</p>
                                        </div>
                                    </li>
                                `).join('') : `<li class="p-6 text-center text-gray-500">This deck has no cards.</li>`}
                            </ul>
                        </div>
                    </div>`;

                document.getElementById('back-to-public-decks').addEventListener('click', renderPublicDecksView);
                document.getElementById('start-quiz-btn').addEventListener('click', () => renderQuizModal(deck));
                
                if (isOwner) {
                    document.getElementById('save-summary-btn').addEventListener('click', async () => {
                        const newSummary = document.getElementById('summary-edit-textarea').value;
                        await updatePublicDeckSummary(publicDeckId, newSummary);
                    });
                }
                
                if (canImport) {
                    document.getElementById('import-deck-btn-detail').addEventListener('click', () => importPublicDeck(publicDeckId));
                }

            } catch (e) {
                console.error("Error fetching public deck details:", e);
                content.innerHTML = `<div class="text-center text-red-500">Failed to load public deck details.</div>`;
            }
        }
        
        async function renderPublicProfileView(profileUserId) {
            setHeader('Public Profile');
            const content = document.getElementById('app-content');
            content.innerHTML = `<div class="text-center text-gray-500">Loading profile...</div>`;

            try {
                // Fetch profile data
                const profileRef = doc(db, `/artifacts/${appId}/users/${profileUserId}/profile`, 'details');
                const profileSnap = await getDoc(profileRef);

                if (!profileSnap.exists()) {
                    content.innerHTML = `<div class="text-center text-red-500">This user profile does not exist.</div>`;
                    return;
                }
                const profileData = profileSnap.data();

                // Fetch user's public decks
                const publicDecksQuery = query(
                    collection(db, `artifacts/${appId}/public_decks`),
                    where("ownerId", "==", profileUserId)
                );
                const publicDecksSnapshot = await getDocs(publicDecksQuery);
                const publicDecks = publicDecksSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));

                const username = profileData.username || 'User';
                const followers = profileData.followers || 0;
                const following = profileData.following || 0;

                content.innerHTML = `
                    <div class="max-w-4xl mx-auto">
                        <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
                            <div class="flex flex-col md:flex-row items-center space-y-4 md:space-y-0 md:space-x-6">
                                <div class="w-24 h-24 bg-gray-200 dark:bg-gray-700 rounded-full flex items-center justify-center">
                                    <span class="text-3xl text-gray-500">${username.charAt(0).toUpperCase()}</span>
                                </div>
                                <div class="flex-1 text-center md:text-left">
                                    <h2 class="text-2xl font-bold">${username}</h2>
                                    <div class="flex justify-center md:justify-start space-x-6 mt-2 text-gray-600 dark:text-gray-400">
                                        <div><strong>${publicDecks.length}</strong> Published Decks</div>
                                        <div><strong>${followers}</strong> Followers</div>
                                        <div><strong>${following}</strong> Following</div>
                                    </div>
                                </div>
                                <div class="flex space-x-2">
                                     <button id="follow-btn" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700">Follow</button>
                                </div>
                            </div>
                        </div>

                        <div class="mt-8">
                            <h3 class="text-xl font-semibold mb-4">Published Decks</h3>
                            ${publicDecks.length > 0 ? `
                                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                                    ${publicDecks.map(deck => {
                                        const cardCount = deck.cards ? deck.cards.length : 0;
                                        return `
                                        <div class="public-deck-card bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden cursor-pointer" data-id="${deck.id}">
                                            <div class="p-4">
                                                <h3 class="text-lg font-semibold text-gray-800 dark:text-white">${deck.topic}</h3>
                                                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">${cardCount} cards</p>
                                            </div>
                                        </div>`;
                                    }).join('')}
                                </div>
                            ` : `
                                <div class="text-center py-12 bg-white dark:bg-gray-800 rounded-lg">
                                    <p class="text-gray-500 dark:text-gray-400">${username} hasn't published any decks yet.</p>
                                </div>
                            `}
                        </div>
                    </div>
                `;

                document.getElementById('follow-btn').addEventListener('click', () => renderPlaceholderModal('follow other users'));

                document.querySelectorAll('.public-deck-card').forEach(card => {
                    card.addEventListener('click', (e) => {
                        renderPublicDeckDetailView(card.dataset.id);
                    });
                });

            } catch (error) {
                console.error("Error rendering public profile:", error);
                content.innerHTML = `<div class="text-center text-red-500">Could not load profile.</div>`;
            }
        }


        // --- Profile View ---
        function renderProfileView() {
            setActiveNav('nav-profile');
            setHeader('Profile');
            const content = document.getElementById('app-content');

            const publishedDecks = allUserDecks.filter(deck => deck.isPublic);

            const username = userProfile?.username || 'User';
            const followers = userProfile?.followers || 0;
            const following = userProfile?.following || 0;

            content.innerHTML = `
                <div class="max-w-4xl mx-auto">
                    <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
                        <div class="flex flex-col md:flex-row items-center space-y-4 md:space-y-0 md:space-x-6">
                            <div class="w-24 h-24 bg-gray-200 dark:bg-gray-700 rounded-full flex items-center justify-center">
                                <span class="text-3xl text-gray-500">${username.charAt(0).toUpperCase()}</span>
                            </div>
                            <div class="flex-1 text-center md:text-left">
                                <h2 class="text-2xl font-bold">${username}</h2>
                                <div class="flex justify-center md:justify-start space-x-6 mt-2 text-gray-600 dark:text-gray-400">
                                    <div><strong>${publishedDecks.length}</strong> Published Decks</div>
                                    <div><strong>${followers}</strong> Followers</div>
                                    <div><strong>${following}</strong> Following</div>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button id="edit-profile-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white dark:bg-gray-700 dark:text-gray-300 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600">Edit Profile</button>
                                <button id="share-profile-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white dark:bg-gray-700 dark:text-gray-300 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600">Share</button>
                            </div>
                        </div>
                    </div>

                    <div class="mt-8">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold">Published Decks</h3>
                            <button id="find-friends-btn" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700">Find Friends</button>
                        </div>
                        
                        ${publishedDecks.length > 0 ? `
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                                ${publishedDecks.map(deck => {
                                    const cardCount = deck.cards ? deck.cards.length : 0;
                                    return `
                                    <div class="deck-card bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden cursor-pointer" data-id="${deck.id}">
                                        <div class="p-4">
                                            <h3 class="text-lg font-semibold text-gray-800 dark:text-white">${deck.topic}</h3>
                                            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">${cardCount} cards</p>
                                        </div>
                                    </div>`;
                                }).join('')}
                            </div>
                        ` : `
                            <div class="text-center py-12 bg-white dark:bg-gray-800 rounded-lg">
                                <p class="text-gray-500 dark:text-gray-400">You haven't published any decks yet.</p>
                            </div>
                        `}
                    </div>
                </div>
            `;

            document.getElementById('edit-profile-btn').addEventListener('click', renderEditProfileModal);
            document.getElementById('share-profile-btn').addEventListener('click', renderShareProfileModal);
            document.getElementById('find-friends-btn').addEventListener('click', () => renderPlaceholderModal('find and follow friends'));
            document.querySelectorAll('.deck-card').forEach(card => card.addEventListener('click', (e) => {
                viewDeck(card.dataset.id);
            }));
        }

        function viewDeck(deckId) {
             renderSingleDeckView(deckId);
        }
        
        function fetchAndDisplayDecks() {
            if (!userId) return;
            const decksCol = collection(db, `/artifacts/${appId}/users/${userId}/decks`);
            onSnapshot(decksCol, (snapshot) => {
                const decks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allUserDecks = decks;
                renderLibrary(decks);
                const mainHeader = document.querySelector('#main-header h1');
                if (mainHeader && mainHeader.textContent === 'My Decks') {
                    renderDecksView(decks);
                }
            });
        }

        function fetchProgressSubjects() {
            if (!userId) return;
            const subjectsCol = collection(db, `/artifacts/${appId}/users/${userId}/progress_subjects`);
            onSnapshot(subjectsCol, (snapshot) => {
                progressSubjects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const currentHeader = document.querySelector('#main-header h1')?.textContent;
                
                const subject = progressSubjects.find(s => s.name === currentHeader || currentHeader.startsWith(s.name + ' ('));
                
                if (currentHeader === 'Progress Tracker') {
                    renderProgressView();
                } else if (subject) {
                    renderSingleSubjectView(subject.id);
                }
            });
        }

        function fetchUserProfile() {
            if (!userId) return;
            const profileRef = doc(db, `/artifacts/${appId}/users/${userId}/profile`, 'details');
            onSnapshot(profileRef, (docSnap) => {
                if (docSnap.exists()) {
                    userProfile = docSnap.data();
                    const userDisplay = document.getElementById('user-display-name');
                    if(userDisplay) {
                        userDisplay.textContent = userProfile.username || auth.currentUser.email;
                        userDisplay.title = userProfile.username || auth.currentUser.email;
                    }
                    // If profile view is active, re-render it
                    if (document.querySelector('#main-header h1')?.textContent === 'Profile') {
                        renderProfileView();
                    }
                } else {
                    console.log("No user profile found.");
                }
            });
        }
        
        // --- EVENT LISTENERS & INITIALIZATION ---
        
        function setupEventListeners() {
            // Sidebar listeners
            document.getElementById('nav-my-decks').addEventListener('click', (e) => {
                e.preventDefault();
                renderDecksView(allUserDecks);
            });
            document.getElementById('nav-progress').addEventListener('click', (e) => {
                e.preventDefault();
                renderProgressView();
            });
             document.getElementById('nav-public-decks').addEventListener('click', (e) => {
                e.preventDefault();
                renderPublicDecksView();
            });
             document.getElementById('nav-profile').addEventListener('click', (e) => {
                e.preventDefault();
                renderProfileView();
            });

            document.getElementById('sidebar-add-deck-btn').addEventListener('click', (e) => {
                e.preventDefault();
                renderAddDeckModal();
            });

            document.getElementById('library-add-btn').addEventListener('click', renderAddDeckModal);

            document.getElementById('library-list').addEventListener('click', (e) => {
                const target = e.target.closest('a');
                if (target && target.dataset.id) {
                    e.preventDefault();
                    const deckId = target.dataset.id;
                    renderSingleDeckView(deckId);
                }
            });

             document.getElementById('sidebar-quiz-btn').addEventListener('click', (e) => {
                e.preventDefault();
                 if (allUserDecks.length > 0) {
                    renderQuizSelectionModal(allUserDecks);
                } else {
                    alert("You don't have any decks to quiz! Create a deck first.");
                }
            });

            document.getElementById('library-search-input').addEventListener('input', (e) => {
                const searchTerm = e.target.value;
                const filteredDecks = searchTerm
                    ? allUserDecks.filter(deck => deck.topic.toLowerCase().includes(searchTerm.toLowerCase()))
                    : allUserDecks;
                renderLibrary(filteredDecks, searchTerm);
            });

            // Logout button
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            
            // Theme toggle listener
            const themeToggleBtn = document.getElementById('theme-toggle');
            const themeToggleDarkIcon = document.getElementById('theme-toggle-dark-icon');
            const themeToggleLightIcon = document.getElementById('theme-toggle-light-icon');

            // Set initial icon visibility based on current theme
            if (document.documentElement.classList.contains('dark')) {
                themeToggleLightIcon.classList.remove('hidden');
            } else {
                themeToggleDarkIcon.classList.remove('hidden');
            }

            themeToggleBtn.addEventListener('click', () => {
                // toggle icons
                themeToggleDarkIcon.classList.toggle('hidden');
                themeToggleLightIcon.classList.toggle('hidden');

                // toggle theme and save preference
                const isDark = document.documentElement.classList.toggle('dark');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');

                if (progressChartInstance) {
                    const textColor = isDark ? '#fff' : '#333';
                    if (progressChartInstance.config.type === 'pie' || progressChartInstance.config.type === 'doughnut') {
                        progressChartInstance.options.plugins.legend.labels.color = textColor;
                    } else if (progressChartInstance.config.type === 'bar') {
                        progressChartInstance.options.scales.x.ticks.color = textColor;
                        progressChartInstance.options.scales.y.ticks.color = textColor;
                        progressChartInstance.options.scales.x.grid.color = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
                    }
                   progressChartInstance.update();
                }
            });
        }

        function initializeAndApplyTheme() {
            const theme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        }
        
        function startApp(firebaseConfig) {
    try {
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        const urlParams = new URLSearchParams(window.location.search);
        const profileId = urlParams.get('profile');

        // Initialize theme
        initializeAndApplyTheme();

        // Set up authentication state listener
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is signed in
                userId = user.uid;
                fetchUserProfile();
                fetchAndDisplayDecks();
                fetchProgressSubjects();
                renderAppLayout();
                setupEventListeners();

                // If a profile ID is in the URL and it's not the current user, show public profile
                if (profileId && profileId !== userId) {
                    renderPublicProfileView(profileId);
                } else {
                    // Default to rendering the user's decks
                    renderDecksView(allUserDecks);
                }
            } else {
                // No user is signed in
                if (profileId) {
                    // If a profile ID is in the URL, show public profile
                    renderPublicProfileView(profileId);
                } else {
                    // Otherwise, show login view
                    renderLoginView();
                }
            }
        });

        // Add modals container if not present
        if (!document.getElementById('modals-container')) {
            const modalsDiv = document.createElement('div');
            modalsDiv.id = 'modals-container';
            document.body.appendChild(modalsDiv);
        }

    } catch (error) {
        console.error("Error initializing app:", error);
        document.getElementById('app-root').innerHTML = '<div class="text-center text-red-500">Failed to load the application.</div>';
    }
}

startApp(firebaseConfig);

    </script>
</body>
</html>
